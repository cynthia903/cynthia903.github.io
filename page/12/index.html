<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> Qida's Blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="学习笔记 知识总结 思考感悟"><meta name="keywords"><meta name="author" content="Qida's Blog"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://qidawu.github.io/atom.xml" title="Qida's Blog"><meta name="generator" content="Hexo 4.2.1"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><a href="/" class="title-link">Qida's Blog</a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><ul class="home post-list"><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/2017/05/06/nginx-proxy/" class="post-title-link">Nginx 反向代理</a></h2><div class="post-info">2017-05-06<a href="/tags/Nginx/" title="Nginx" class="post-demo">Nginx</a></div><div class="post-content"><h1 id="什么是代理？"><a href="#什么是代理？" class="headerlink" title="什么是代理？"></a>什么是代理？</h1><p>一张图了解两种代理模式的区别：</p>
<p><img src="/img/nginx/proxy.jpg" alt="两种代理模式"></p>
<p>常见应用场景：</p>
<ul>
<li>正向代理：VPN 翻墙</li>
<li>反向代理：Web 站点服务</li>
</ul>
<h1 id="Nginx-反向代理"><a href="#Nginx-反向代理" class="headerlink" title="Nginx 反向代理"></a>Nginx 反向代理</h1><p>Nginx 代理功能由标准 HTTP 模块中内置的 <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" target="_blank" rel="noopener">ngx_http_proxy_module</a> 提供，因此无需额外编译，常见配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        server_name example.com;</span><br><span class="line">        listen 80;</span><br><span class="line">        </span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;127.0.0.1:81&#x2F;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>proxy_pass</code> 指令用于配置被代理服务器的协议和地址。除了配置单机，还可以配置集群，详见 <a href="/2017/05/13/nginx-upstream/">Nginx 负载均衡</a> 。</p>
<h1 id="解决代理后的问题"><a href="#解决代理后的问题" class="headerlink" title="解决代理后的问题"></a>解决代理后的问题</h1><h2 id="上游无法获取真实的访问来源信息"><a href="#上游无法获取真实的访问来源信息" class="headerlink" title="上游无法获取真实的访问来源信息"></a>上游无法获取真实的访问来源信息</h2><p>使用反向代理之后，上游服务器（如 Tomcat）无法获取真实的访问来源信息（如协议、域名、访问 IP），例如下面代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request.getScheme() <span class="comment">// 总是 http，而不是实际的 http 或 https</span></span><br><span class="line">request.isSecure() <span class="comment">// 总是 false</span></span><br><span class="line">request.getRemoteAddr() <span class="comment">// Nginx IP</span></span><br><span class="line">request.getServerName() <span class="comment">// 127.0.0.1</span></span><br><span class="line">request.getRequestURL() <span class="comment">// http://127.0.0.1:81/index</span></span><br><span class="line">response.sendRedirect(...) <span class="comment">// 总是重定向到 http</span></span><br></pre></td></tr></table></figure>

<p>这个问题需要在 Nginx 和 Tomcat 中做一些配置以解决问题。</p>
<p>Nginx 配置：</p>
<p>使用 <code>proxy_set_header</code> 指令为上游服务器添加请求头：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    proxy_set_header Host              $host;</span><br><span class="line">    proxy_set_header X-Real-IP         $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Tomcat 配置：</p>
<p>在 Tomcat 的 <code>server.xml</code> 中配置 <a href="http://tomcat.apache.org/tomcat-7.0-doc/api/org/apache/catalina/valves/RemoteIpValve.html" target="_blank" rel="noopener">RemoteIpValve</a> 让代码能够获取真实 IP 和协议：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Valve className&#x3D;&quot;org.apache.catalina.valves.RemoteIpValve&quot; </span><br><span class="line">    remoteIpHeader&#x3D;&quot;X-Forwarded-For&quot; </span><br><span class="line">    protocolHeader&#x3D;&quot;X-Forwarded-Proto&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>解决结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">request.getScheme() <span class="comment">// 实际的 http 或 https</span></span><br><span class="line">request.isSecure() <span class="comment">// 对应的 false 或 true</span></span><br><span class="line">request.getRemoteAddr() <span class="comment">// 用户 IP</span></span><br><span class="line">request.getHeader(<span class="string">"X-Real-IP"</span>) <span class="comment">// 用户 IP</span></span><br><span class="line">request.getServerName() <span class="comment">// example.com</span></span><br><span class="line">request.getRequestURL() <span class="comment">// 对应的 http://example.com/index 或 https://example.com/index</span></span><br><span class="line">response.sendRedirect(...) <span class="comment">// 实际的 http 或 https</span></span><br></pre></td></tr></table></figure>

<h2 id="全局-proxy-set-header-失效"><a href="#全局-proxy-set-header-失效" class="headerlink" title="全局 proxy_set_header 失效"></a>全局 proxy_set_header 失效</h2><p>先来看下 <code>proxy_set_header</code> 的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">语法:	proxy_set_header field value;</span><br><span class="line">默认值: proxy_set_header Host $proxy_host;</span><br><span class="line">        proxy_set_header Connection close;</span><br><span class="line">上下文: http, server, location</span><br><span class="line"></span><br><span class="line">允许重新定义或者添加发往后端服务器的请求头。value 可以包含文本、变量或者它们的组合。当且仅当当前配置级别中没有定义 proxy_set_header 指令时，会从上面的级别继承配置。 默认情况下，只有两个请求头会被重新定义：</span><br><span class="line"></span><br><span class="line">proxy_set_header Host       $proxy_host;</span><br><span class="line">proxy_set_header Connection close;</span><br></pre></td></tr></table></figure>

<p>这里隐含一个坑：<strong>如果当前配置级别中定义了 <code>proxy_set_header</code> 指令，哪怕只配置了一个，都会导致无法从上面的级别继承配置</strong>，即导致全局级别的 <code>proxy_set_header</code> 配置失效。例如下述 HTTP <a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive" target="_blank" rel="noopener">长连接配置</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    proxy_set_header Host              $host;</span><br><span class="line">    proxy_set_header X-Real-IP         $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line"></span><br><span class="line">    upstream backend &#123;</span><br><span class="line">        server 127.0.0.1:8080;</span><br><span class="line">        keepalive 16;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;backend;</span><br><span class="line">            proxy_http_version 1.1;</span><br><span class="line">            proxy_set_header Connection &quot;&quot;;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>导致全局级别的 <code>proxy_set_header</code> 配置失效：</p>
<p><img src="/img/nginx/problem_of_proxy_set_header.png" alt="proxy_set_header 失效"></p>
<p>解决办法是在 <code>location</code> 中重新配置这四个请求头。</p>
</div></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/2017/05/01/maven-build-lifecycle/" class="post-title-link">Maven 实战系列（五）构建生命周期</a></h2><div class="post-info">2017-05-01<a href="/tags/Java/" title="Java" class="post-demo">Java</a></div><div class="post-content"><p>本文用于理顺 Maven 构建的生命周期（Build Lifecycle）概念，掌握执行 Maven 命令时其背后的原理。</p>
<h1 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h1><h2 id="生命周期（Lifecycle）"><a href="#生命周期（Lifecycle）" class="headerlink" title="生命周期（Lifecycle）"></a>生命周期（Lifecycle）</h2><p>生命周期（Lifecycle）是一个抽象的概念，意味着它并不做任何实质性的事情，也就是说它像接口，只定义规范，具体细节不管。具体的实现细节则交给了 Maven 各个插件（Plugin）。</p>
<p>生命周期（Lifecycle）是一系列有序的阶段（Phase），而插件的目标（Goal）是跟某个生命周期的阶段绑定在一起的，如果一个阶段没有绑定任何目标，则运行该阶段没有任何实质意义。</p>
<p>摘录一段官方的描述：</p>
<blockquote>
<p>A Build lifecycle is Made Up of build Phases.</p>
<p>A build phase represents a stage in the lifecycle.</p>
<p>A Build Phase is Made Up of Goals.</p>
</blockquote>
<p>Maven 内置三种生命周期：</p>
<table>
<thead>
<tr>
<th>内置 Lifecycle</th>
<th>描述</th>
<th>内置 Phase 数量</th>
</tr>
</thead>
<tbody><tr>
<td><code>clean</code></td>
<td>Project cleaning</td>
<td>3 个</td>
</tr>
<tr>
<td><code>default</code></td>
<td>Project deployment</td>
<td>23 个</td>
</tr>
<tr>
<td><code>site</code></td>
<td>Creation of project’s site documentation</td>
<td>4 个</td>
</tr>
</tbody></table>
<h2 id="阶段（Phase）"><a href="#阶段（Phase）" class="headerlink" title="阶段（Phase）"></a>阶段（Phase）</h2><p>Phase 虽然很多，但其中带连字符 (<code>pre-*</code>, <code>post-*</code>, or <code>process-*</code>) 的 Phase 通常不会在命令行中直接使用。</p>
<p>那么有哪些常用的 Phase？</p>
<table>
<thead>
<tr>
<th>Phase</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>clean</code></td>
<td>remove all files generated by the previous build.</td>
</tr>
<tr>
<td><code>complie</code></td>
<td>compile the source code of the project</td>
</tr>
<tr>
<td><code>test</code></td>
<td>test the compiled source code using a suitable unit testing framework. These tests should not require the code be packaged or deployed.</td>
</tr>
<tr>
<td><code>package</code></td>
<td>take the compiled code and package it in its distributable format, such as a JAR.</td>
</tr>
<tr>
<td><code>install</code></td>
<td>install the package into the local repository, for use as a dependency in other projects locally</td>
</tr>
<tr>
<td><code>deploy</code></td>
<td>done in the build environment, copies the final package to the remote repository for sharing with other developers and projects.</td>
</tr>
</tbody></table>
<p>如何运行一个 Phase？使用命令 <code>mvn phase</code>。运行时，首先由该 phase 确定对应的生命周期。然后从生命周期的第一个 Phase 开始，<strong>按顺序</strong>运行到该 phase。</p>
<h2 id="目标（Goal）"><a href="#目标（Goal）" class="headerlink" title="目标（Goal）"></a>目标（Goal）</h2><p>Phase 是一个逻辑概念，本身并不包含任何构建信息，运行 Phase 时，只是运行绑定到该 Phase 的 Goal。</p>
<p>Plugin 是一个物理概念，安装了 Plugin 才会有相应的一些 Goal。而每个 Goal 代表了该 Plugin 的一种能力。如果要直接运行一个 Goal，可以使用 <code>mvn &lt;plugin-prefix&gt;:&lt;goal&gt;</code>。其中 plugin-prefix 的<a href="http://maven.apache.org/guides/introduction/introduction-to-plugin-prefix-mapping.html" target="_blank" rel="noopener">约定格式</a>如下：</p>
<table>
<thead>
<tr>
<th>约定格式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>maven-${prefix}-plugin</code></td>
<td>Apache Maven 团队维护的官方插件。例如 <code>maven-compiler-plugin</code>，命令：<code>mvn dependency:list</code></td>
</tr>
<tr>
<td><code>${prefix}-maven-plugin</code></td>
<td>其它插件。例如 <code>spring-boot-maven-plugin</code>，命令：<code>mvn spring-boot:run</code></td>
</tr>
</tbody></table>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html" target="_blank" rel="noopener">http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html</a></p>
</div></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/2017/04/26/maven-bom/" class="post-title-link">Maven 实战系列（四）BOM 依赖管理（组合关系）</a></h2><div class="post-info">2017-04-26<a href="/tags/Java/" title="Java" class="post-demo">Java</a></div><div class="post-content"><p>在大型项目中，BOM 用于将一组相关的、可以良好协作的构建（Maven Artifact）组合在一起，提供版本管理，避免构件间潜在的版本不兼容风险。</p>
<p>BOM 如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>test<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>project-n-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span>  <span class="comment">&lt;!-- 必须是 pom --&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 属性配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties...</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 依赖管理配置，声明该 BOM 管理的依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement...</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>例如常用的 Reactor、Spring Boot、Spring Cloud：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Import dependency management from Reactor --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;reactor.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- Import dependency management from Spring Boot --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- Import dependency management from Spring Cloud --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="实践例子（一）"><a href="#实践例子（一）" class="headerlink" title="实践例子（一）"></a>实践例子（一）</h1><p>每个公司可能都拥有自己的标准父项目，为了解决 Maven 单继承问题，可以通过组合方式使用 <code>&lt;dependencyManagement&gt;</code> 依赖管理来享受其提供的版本管理的好处。</p>
<h1 id="实践例子（二）"><a href="#实践例子（二）" class="headerlink" title="实践例子（二）"></a>实践例子（二）</h1><p><code>&lt;dependencyManagement&gt;</code> 用于在具有层级关系的项目间统一管理依赖的版本，一般用在父项目中，通过它来管理 jar 包的版本，让子项目中引用一个依赖而不用显式的指定版本号，以达到<strong>依赖版本统一管理</strong>的目的。</p>
<p>这种方法的好处是显而易见的。依赖的细节（如版本号）可以在一个中心位置集中设置，并传播到所有继承的 POM。</p>
<p>但由于现实中有可能是 N 个项目都继承同一个父项目，如果把它们的依赖全部放到父项目的 <code>&lt;DependencyManagement&gt;</code> 中管理，势必会导致父项目的依赖配置急剧膨胀，形成一个巨型 POM。更为关键的是，后续各项目组都有升级各自提供的依赖版本的需要，如果大家都去改这个公共的父项目，版本管理会变得很混乱。</p>
<p>解决办法是按项目组粒度对依赖进行分组管理，分而治之。将每组依赖抽取成像 <code>spring-boot-dependencies</code> 一样的 BOM，并在父项目中 <code>&lt;dependencyManagement&gt;</code> 使用 <code>scope=import</code> 方式将这些 BOM 组合起来，这样父项目的 POM 就会十分干净且稳定，各组依赖的版本管理也能转由各自项目组的 BOM 专门负责，类似一个金字塔模型。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">                   +------------+</span><br><span class="line">                   | parent-pom |</span><br><span class="line">                   +------+-----+</span><br><span class="line">                          |</span><br><span class="line">        +-----------------|-----------------+</span><br><span class="line">        |                 |                 |</span><br><span class="line">+-------v-------+ +-------+-------+ +-------v-------+</span><br><span class="line">| Project-A-BOM | | Project-B-BOM | | Project-N-BOM |</span><br><span class="line">+---------------+ +-------+-------+ +---------------+</span><br><span class="line">                          |</span><br><span class="line">           +--------------|---------------+</span><br><span class="line">           |              |               |</span><br><span class="line">     +-----v------+ +-----v------+ +------v-----+</span><br><span class="line">     | Artifact-A | | Artifact-B | | Artifact-N |</span><br><span class="line">     +------------+ +------------+ +------------+</span><br></pre></td></tr></table></figure>

<p>例如某个公司的标准父项目 POM 如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>test<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span>  <span class="comment">&lt;!-- 必须是 pom --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- Import dependency management from Spring Boot 1 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 此处省略 N 组依赖 --&gt;</span></span><br><span class="line">            ......</span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>开发阶段为了测试 Spring Boot 2 的兼容性，该公司 child 项目新开 git 分支，修改 POM 如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>test<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>child<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- Import dependency management from Spring Boot 2 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上例 child 项目覆盖了父项目 <code>&lt;dependencyManagement&gt;</code> 的 Spring Boot 版本，当兼容性测试通过后，子项目 <code>&lt;dependencyManagement&gt;</code> 即可去掉，转而升级父项目 Spring Boot 的版本号即可，这样所有子项目都会统一升级版本。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/using-boot-build-systems.html" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/docs/current/reference/html/using-boot-build-systems.html</a></p>
<p><a href="https://projectreactor.io/docs/core/release/reference/#getting-started-understanding-bom" target="_blank" rel="noopener">https://projectreactor.io/docs/core/release/reference/#getting-started-understanding-bom</a></p>
</div></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/2017/04/21/maven-inheritance/" class="post-title-link">Maven 实战系列（三）继承与聚合关系</a></h2><div class="post-info">2017-04-21<a href="/tags/Java/" title="Java" class="post-demo">Java</a></div><div class="post-content"><p>除了依赖关系，继承和聚合关系也是 Maven 项目中很常用的两种关系。</p>
<h1 id="继承关系"><a href="#继承关系" class="headerlink" title="继承关系"></a>继承关系</h1><ul>
<li>在子项目中，使用 <code>&lt;parent&gt;</code> 指定父项目；</li>
<li>项目能继承父项目的一些配置（属性，依赖等）；</li>
<li>一般用于多项目共享父配置。</li>
<li>特别注意 <code>relativePath</code> 元素。虽非必填，但可以用作 Maven 的一个指示符，以在搜索本地和远程仓库之前首先搜索此路径，以达到优先使用本地父项目的目的（本地开发过程中有时我们会修改本地父项目的配置，例如修改依赖版本号）。</li>
</ul>
<p>父项目配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>test<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span>  <span class="comment">&lt;!-- 必须是 pom --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 以下配置都可以被子项目继承 --&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 属性配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties...</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 依赖管理配置，如 spring-cloud、spring-boot、reactor --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement...</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 依赖配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies...</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 构建配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build...</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Nexus 分发包地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">distributionManagement...</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Nexus 仓库地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories...</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Nexus 插件地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepositories...</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>子项目配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>test<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../parent<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>test<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  <span class="comment">&lt;!-- 可继承自父项目 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>child-a<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  <span class="comment">&lt;!-- 可继承自父项目 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="聚合关系"><a href="#聚合关系" class="headerlink" title="聚合关系"></a>聚合关系</h1><ul>
<li>在父项目中，使用 <code>&lt;modules&gt;</code> 指定子项目；</li>
<li>在父项目中进行构建，会同时构建全部子项目；</li>
<li>一般用于批量管理一个项目的多个模块；</li>
</ul>
<p>父项目配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>test<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span>  <span class="comment">&lt;!-- 必须是 pom --&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 子模块相对于父项目的路径，一般为 artifactId --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>child-a<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>child-a<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

</div></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/2017/04/15/maven-dependencies/" class="post-title-link">Maven 实战系列（二）依赖关系总结</a></h2><div class="post-info">2017-04-15<a href="/tags/Java/" title="Java" class="post-demo">Java</a></div><div class="post-content"><h1 id="依赖关系"><a href="#依赖关系" class="headerlink" title="依赖关系"></a>依赖关系</h1><p>依赖关系是 Maven 项目之间最常见的关系。Maven 会自动解析所有项目的<strong>直接依赖</strong>和<strong>传递性依赖</strong>，并且根据规则正确判断<strong>每个依赖范围（Dependency Scope）</strong>。对于一些依赖冲突，自动进行<strong>依赖调解（Dependency Mediation）</strong>，或开发者<strong>手动排除依赖（exclusions）</strong>，以确保任何一个构件只有唯一的版本在依赖中存在。经过这些工作之后，得到的那些依赖被称为<strong>已解析依赖（Resolved Dependency）</strong>，从而产生一个 Effective POM。</p>
<h2 id="依赖配置"><a href="#依赖配置" class="headerlink" title="依赖配置"></a>依赖配置</h2><p>下面是一段依赖配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    …</span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>…<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>        <span class="comment">&lt;!-- 依赖的构件属组 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>…<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  <span class="comment">&lt;!-- 依赖的构件ID --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>…<span class="tag">&lt;/<span class="name">version</span>&gt;</span>        <span class="comment">&lt;!-- 依赖的构件版本 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>…<span class="tag">&lt;/<span class="name">type</span>&gt;</span>              <span class="comment">&lt;!-- 依赖类型，默认值为 jar --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>…<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>            <span class="comment">&lt;!-- 依赖范围 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>…<span class="tag">&lt;/<span class="name">optional</span>&gt;</span>      <span class="comment">&lt;!-- 可选依赖，默认情况下不会被继承，只有声明了该依赖才会继承 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span>                <span class="comment">&lt;!-- 排除(传递性)依赖 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span>…<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                …</span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        …</span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    …</span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="依赖传递"><a href="#依赖传递" class="headerlink" title="依赖传递"></a>依赖传递</h2><p>Maven 会解析各个直接依赖的 POM，将那些必要的间接依赖，以<strong>传递性依赖</strong>的方式引入到当前项目中，而开发者不用再考虑该直接依赖还依赖了什么，或手动引入导致多余依赖：</p>
<p><img src="/img/java/maven/transitive_dependencies.png" alt="传递性依赖"></p>
<h2 id="依赖调解"><a href="#依赖调解" class="headerlink" title="依赖调解"></a>依赖调解</h2><p>Maven 调解依赖有两个基本原则：</p>
<ol>
<li>第一原则：<strong>路径最短者优先</strong>。<br>假设 X 是 A 的传递性依赖：A-&gt;B-&gt;C-&gt;X(1.0) 依赖路径长度为 3，A-&gt;D-&gt;X(2.0) 长度为 2，则 X(2.0) 会先被解析使用。</li>
<li>第二原则：<strong>第一声明者优先</strong>。<br>在依赖路径长度相等的前提下，在 POM 中，依赖声明的顺序决定了谁会先被解析使用。</li>
</ol>
<h2 id="依赖范围-scope"><a href="#依赖范围-scope" class="headerlink" title="依赖范围 scope"></a>依赖范围 scope</h2><p>依赖范围 <code>scope</code> 用于控制依赖与这三种 classpath（编译、测试、运行）的关系，即是否有效：</p>
<table>
<thead>
<tr>
<th>依赖范围（Scope）</th>
<th>编译classpath</th>
<th>测试classpath</th>
<th>运行classpath</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td><code>compile</code></td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>spring-core</td>
</tr>
<tr>
<td><code>test</code></td>
<td>×</td>
<td>√</td>
<td>×</td>
<td>spring-test、junit、mockito</td>
</tr>
<tr>
<td><code>provided</code></td>
<td>√</td>
<td>√</td>
<td>×</td>
<td>servlet-api（运行时，由于容器如tomcat已经提供，无须重复引入）</td>
</tr>
<tr>
<td><code>runtime</code></td>
<td>×</td>
<td>√</td>
<td>√</td>
<td>JDBC 驱动实现（编译时，只需 JDK 提供的 JDBC 接口；运行时，才需要接口的具体实现）</td>
</tr>
<tr>
<td><code>system</code></td>
<td>√</td>
<td>√</td>
<td>×</td>
<td>本地的，Maven 仓库之外的类库文件</td>
</tr>
<tr>
<td><code>import</code></td>
<td>/</td>
<td>/</td>
<td>/</td>
<td>Maven 2.0.9 版本后出的属性，<code>import</code> 只能在 <code>dependencyManagement</code> 的中使用，能解决 Maven 单继承问题，<code>import</code> 依赖关系实际上并不参与限制依赖关系的传递性。</td>
</tr>
</tbody></table>
<h2 id="可选依赖-optional"><a href="#可选依赖-optional" class="headerlink" title="可选依赖 optional"></a>可选依赖 optional</h2><p>可选依赖 <code>optional</code> 为 <code>true</code> 时，该依赖不会被传递进来。</p>
<h2 id="依赖排除-exclusions"><a href="#依赖排除-exclusions" class="headerlink" title="依赖排除 exclusions"></a>依赖排除 exclusions</h2><p>当传递性依赖的结果不是自己预期的构件版本，可以排除依赖重新自定义。下例展示了使用 <code>&lt;exclusions&gt;</code> 排除 A 的传递性依赖 C，并显式声明依赖 C(1.10)：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    …</span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>…<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>A<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span>  <span class="comment">&lt;!-- 排除 A 的传递性依赖 C --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>…<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>C<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                …</span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 显式声明依赖 C(1.10) --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>…<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>C<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        …</span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    …</span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果如图：</p>
<p><img src="/img/java/maven/exclusion_dependencies.png" alt="依赖排除"></p>
<h2 id="依赖归类"><a href="#依赖归类" class="headerlink" title="依赖归类"></a>依赖归类</h2><p>当多个构件使用同一版本号时，为了便于后期统一升级维护，可以使用 <code>&lt;properties&gt;</code> 属性统一定义：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    …</span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring.version</span>&gt;</span>5.0.0.RELEASE<span class="tag">&lt;/<span class="name">spring.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    …</span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><h2 id="解决依赖冲突"><a href="#解决依赖冲突" class="headerlink" title="解决依赖冲突"></a>解决依赖冲突</h2><p>例如在使用 Spring Boot 时，其依赖引入了一个有缺陷的 Jackson 框架版本 1.9.X，此时需要覆盖起步依赖引入的传递依赖：</p>
<p>方式一，如果项目未使用 Jackson 相关功能，可以使用 <code>&lt;exclusions&gt;</code> 排除依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>方式二，如果项目使用了，可以利用“就近原则”，覆盖传递依赖的版本号，修复缺陷：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="依赖下载问题"><a href="#依赖下载问题" class="headerlink" title="依赖下载问题"></a>依赖下载问题</h2><p>有时候某个依赖下载有问题时，会导致本地环境找不到相关类。此时可以找到本地仓库下的相关 jar 包目录，排查下是否只有 <code>*.lastupdated</code> 文件而没有相应 jar 包。如果是，则删掉该目录重新下载依赖即可。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://maven.apache.org/guides/introduction/introduction-to-optional-and-excludes-dependencies.html" target="_blank" rel="noopener">http://maven.apache.org/guides/introduction/introduction-to-optional-and-excludes-dependencies.html</a></p>
<p><a href="https://juejin.im/post/6844903987322290189" target="_blank" rel="noopener">Maven optional关键字透彻图解</a></p>
</div></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/2017/04/08/maven-pom-basics/" class="post-title-link">Maven 实战系列（一）POM 基础知识</a></h2><div class="post-info">2017-04-08<a href="/tags/Java/" title="Java" class="post-demo">Java</a></div><div class="post-content"><h1 id="Maven-坐标"><a href="#Maven-坐标" class="headerlink" title="Maven 坐标"></a>Maven 坐标</h1><p>Maven 定义了这样一组规则：世界上任何一个<em>构件</em>都可以使用 Maven 坐标唯一标识，Maven 坐标的元素包括：</p>
<table>
<thead>
<tr>
<th>坐标元素</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>groupId</td>
<td>必选。定义当前 Maven 项目隶属的实际项目。</td>
</tr>
<tr>
<td>artifactId</td>
<td>必选。定义实际项目中的一个 Maven 项目（模块），推荐使用实际项目名称作为前缀。</td>
</tr>
<tr>
<td>version</td>
<td>必选。定义当前 Maven 项目所处版本。</td>
</tr>
<tr>
<td>packaging</td>
<td>可选。定义 Maven 项目的打包方式，默认为 <code>jar</code>。</td>
</tr>
<tr>
<td>classifier</td>
<td>不能直接定义。用来帮助定义构建输出的一些附属构件。如 javadoc、sources。</td>
</tr>
</tbody></table>
<h1 id="POM-关系类型"><a href="#POM-关系类型" class="headerlink" title="POM 关系类型"></a>POM 关系类型</h1><p>Maven 一个强大的地方在于处理项目之间的关系。其中包括<strong>依赖关系</strong>（包括传递性依赖关系）、<strong>继承关系</strong>和<strong>聚合关系</strong>（多模块项目）。 </p>
<p>详见：《<a href="/2018/04/20/maven-dependencies/">Maven 依赖关系</a>》、《<a href="/2018/04/21/maven-inheritance/">Maven 继承关系与聚合关系</a>》</p>
<h1 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h1><p>Maven 属性是类似于 Ant 属性一样的值占位符。可以通过符号  <code>${X}</code>（其中 <code>X</code> 是属性）在 POM 中的任意位置访问它们的值。它们也可以被插件用作默认值使用，例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>共有五种风格的占位符：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><code>${env.X}</code></td>
<td>返回 shell 的环境变量。例如 <code>${env.PATH}</code> 返回 PATH 环境变量。为了可靠性，Maven 2.1.0 开始将环境变量的名称归一化为全部大写。</td>
</tr>
<tr>
<td><code>${project.x}</code></td>
<td>返回 pom.xml 文件中对应元素的值。 例如可通过 <code>${project.version}</code> 访问 <code>&lt;project&gt;&lt;version&gt;1.0&lt;/version&gt;&lt;/project&gt;</code>。</td>
</tr>
<tr>
<td><code>${settings.x}</code></td>
<td>返回 settings.xml 文件中对应元素的值。例如 <code>&lt;settings&gt;&lt;offline&gt;false&lt;/offline&gt;&lt;/settings&gt;</code> 可通过 <code>${settings.offline}</code> 访问。</td>
</tr>
<tr>
<td><code>${java.x}</code></td>
<td>返回 Java 系统属性。 通过 <code>java.lang.System.getProperties()</code> 可访问的所有属性都可用作 POM 属性，例如<code>${java.home}</code>。</td>
</tr>
<tr>
<td><code>${x}</code></td>
<td>返回 pom.xml 文件中 <code>&lt;properties/&gt;</code> 元素内的值。例如 <code>&lt;spring.version&gt;1.0.1-SNAPSHOT&lt;/spring.version&gt;</code> 可通过 <code>${spring.version}</code> 访问。</td>
</tr>
</tbody></table>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://maven.apache.org/pom.html" target="_blank" rel="noopener">http://maven.apache.org/pom.html</a></p>
</div></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/2017/03/21/git-startup/" class="post-title-link">Git 实战系列（十五）Git 学习之路</a></h2><div class="post-info">2017-03-21<a href="/tags/Git/" title="Git" class="post-demo">Git</a></div><div class="post-content"><p>学习 Git 快一年了，感受良多，总结如下。</p>
<h1 id="如何开始？"><a href="#如何开始？" class="headerlink" title="如何开始？"></a>如何开始？</h1><p>早年的时候，为了获取优质的项目和资源，注册了 GitHub 的账号，但仅仅简单用了 Star 和 Clone 功能。后来开始想在 GitHub 上面托管一些资源，陆续做了一些功课：</p>
<ul>
<li>LinuxCast Git 视频教程，手把手指导，可惜教程不再维护了。</li>
<li><a href="http://git-scm.com/book/" target="_blank" rel="noopener">Git 官方文档</a>，第一手官方材料，由浅入深，涉及 Git 各方面的内容，建议有实操经验的同学深入阅读。</li>
<li><a href="https://help.github.com" target="_blank" rel="noopener">GitHub 帮助文档</a>，偏向实操，建议初学者阅读。而且里面涉及到一些 GitHub 特性（图形化操作、Social、Pages）可以与 Git 互补。</li>
<li>廖雪峰的博客</li>
</ul>
<p>其实网上相关教程、博客、书籍很多，但建议初学者重心先放在：</p>
<ul>
<li>基础命令的实操（推荐 <a href="https://training.github.com/kit/downloads/github-git-cheat-sheet.pdf" target="_blank" rel="noopener">Git cheatsheet</a>，按功能分组命令，便于记忆）</li>
<li>简单概念的理解（例如重点关注 Git 文件流转的三个工作区域及远程仓库，至于配置、分支（我知道分支是 Git 的杀手锏功能，但事实上很多人只用到一个 master 分支）、工作流等先统统忽略）</li>
</ul>
<p>然后安装好 Git，选择好一个代码托管商（如国外 <a href="https://www.github.com" target="_blank" rel="noopener">GitHub</a>，国内 <a href="https://gitcafe.com" target="_blank" rel="noopener">GitCafe</a>），赶紧先跑起来，再好起来！如果你曾大致了解过 Git 这一门技术，你会发现这是属于“记忆型”的技术，需要多用才熟能生巧。</p>
<h1 id="我的学习轨迹"><a href="#我的学习轨迹" class="headerlink" title="我的学习轨迹"></a>我的学习轨迹</h1><h2 id="第一轮"><a href="#第一轮" class="headerlink" title="第一轮"></a>第一轮</h2><p>第一轮学习从零开始，大致如下：</p>
<ul>
<li>简单阅读了一些文档，用思维导图做成笔记。</li>
<li>安装客户端，实操命令。</li>
<li>把所做所得整理成 PPT，用自己的理解在团队内部做了一次技术分享，反响不错，还加深了自己的理解。</li>
</ul>
<h2 id="第二轮"><a href="#第二轮" class="headerlink" title="第二轮"></a>第二轮</h2><p>第二轮的起因是因为想用 GitHub Pages 服务搭建一个静态博客写写文章。由于已经有了第一轮的沉淀，这回学习速度就很快了。还顺便学会了 Markdown 语法和 Hexo 博客搭建。</p>
<h2 id="第三轮"><a href="#第三轮" class="headerlink" title="第三轮"></a>第三轮</h2><p>第三轮是因为跳槽后新公司正好使用的是 Git，但由于团队成员用得都不熟练，因此利用空余时间进一步研究了 Git 的进阶内容：</p>
<ul>
<li>分支管理与团队工作流程</li>
<li>冲突解决方案</li>
<li><code>pull</code>、<code>merge</code>、<code>log</code>、<code>reset</code>、<code>checkout</code> 等实用命令</li>
<li><code>rebase</code>、<code>cherry-pick</code> 等高级命令</li>
</ul>
<p>整个过程使用的是“INK 学习法”，并再次将理解的内容整理成 PPT 与团队分享。这轮学习的不同之处在于：</p>
<ul>
<li>以往都是个人使用 Git，使用的命令都很简单。当与团队一起使用时，问题规模不同，对工具的理解也会进一步加深。</li>
<li>与第一次纯粹分享不同，这次侧重于推广我的方案，规范团队的工作流程，将知识转化为生产力。</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>学习的轨迹应当是螺旋向上，难易度逐轮递增。每一轮的学习主题还应有所侧重，意图一口一个大胖子的行为会噎死自己 :)</p>
<p>如今 Git 对我来说不止是门技术，更是一种生活方式。除了工作中每天都要用到，通过它还“连接”了我与开源世界。</p>
</div></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/2017/03/15/git-transfer-project/" class="post-title-link">Git 实战系列（十四）Git 远程仓库迁移</a></h2><div class="post-info">2017-03-15<a href="/tags/Git/" title="Git" class="post-demo">Git</a></div><div class="post-content"><h1 id="1-获取权限"><a href="#1-获取权限" class="headerlink" title="1.获取权限"></a>1.获取权限</h1><p>首先获取相关 Group 的 Owner 权限。</p>
<h1 id="2-在线迁移"><a href="#2-在线迁移" class="headerlink" title="2.在线迁移"></a>2.在线迁移</h1><p><img src="/img/git/git_transfer_project.png" alt="Git 迁移项目"></p>
<h1 id="3-更新本地仓库"><a href="#3-更新本地仓库" class="headerlink" title="3.更新本地仓库"></a>3.更新本地仓库</h1><p>更新本地仓库，首先查看当前 remote url：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git remote -v</span><br><span class="line">origin  git@git.kd.ssj:finance-ssjmarket/finance-market.git (fetch)</span><br><span class="line">origin  git@git.kd.ssj:finance-ssjmarket/finance-market.git (push)</span><br></pre></td></tr></table></figure>

<p>使用 <code>git remote set-url</code>  重置 remote url：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git remote <span class="built_in">set</span>-url origin git@git.kd.ssj:finance-web/finance-market.git</span><br></pre></td></tr></table></figure>

<p>检查重置是否成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git remote -v</span><br><span class="line">origin  git@git.kd.ssj:finance-web/finance-market.git (fetch)</span><br><span class="line">origin  git@git.kd.ssj:finance-web/finance-market.git (push)</span><br></pre></td></tr></table></figure>

<h1 id="4-批量更新本地仓库"><a href="#4-批量更新本地仓库" class="headerlink" title="4 批量更新本地仓库"></a>4 批量更新本地仓库</h1><p>适用于一堆 git 仓库放在同一个目录下，可以用这个方法进行批量替换：</p>
<ol>
<li>检查一下现在的 url：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat .&#x2F;finance-*&#x2F;.git&#x2F;config | grep &#39;git@&#39;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>批量替换：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -1 .&#x2F;仓库名-*&#x2F;.git&#x2F;config | xargs  sed -i &#39;s&#x2F;git@.*\:&#x2F;git@github.com:&#x2F;g&#39;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>再次检查一下结果：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat .&#x2F;finance-*&#x2F;.git&#x2F;config | grep &#39;git@&#39;</span><br></pre></td></tr></table></figure>

</div></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/2017/03/02/mycli/" class="post-title-link">MyCli：支持自动补全和语法高亮的 MySQL 客户端</a></h2><div class="post-info">2017-03-02<a href="/tags/MySQL/" title="MySQL" class="post-demo">MySQL</a></div><div class="post-content"><p>工作中常用到 mysql 自带的命令行工具，但实在难用。推荐一款 MySQL 命令行工具——<a href="http://mycli.net/" target="_blank" rel="noopener">MyCli</a>，支持<strong>自动补全</strong>和<strong>语法高亮</strong>。也可用于 MariaDB 和 Percona。</p>
<p>功能如下：</p>
<p><img src="/img/mysql/mycli.gif" alt="MyCLI"></p>
<p>MyCLI 的兼容性爆表，支持 Windows、MacOS、Linux，运行在 Python 2.7, 3.3, 3.4, 3.5, 3.6。安装简易，例如 Windows 只要安装了 <a href="https://www.python.org/downloads/" target="_blank" rel="noopener">Python 环境</a>及其包管理工具 <code>pip</code> ，就能一键安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ pip install mycli</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">$ easy_install mycli</span><br></pre></td></tr></table></figure>

<p>其它系统的安装方式，请参考：<a href="http://mycli.net/install" target="_blank" rel="noopener">http://mycli.net/install</a></p>
<p>Windows 下使用 <code>cmd</code> 连接数据库，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mycli -hlocalhost -P3306 -uroot -p123456</span><br></pre></td></tr></table></figure>

</div></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/2017/02/10/java-jackson/" class="post-title-link">JSON 框架系列之 Jackson 总结</a></h2><div class="post-info">2017-02-10<a href="/tags/Java/" title="Java" class="post-demo">Java</a></div><div class="post-content"><h1 id="JsonNode-的使用"><a href="#JsonNode-的使用" class="headerlink" title="JsonNode 的使用"></a>JsonNode 的使用</h1><p><code>com.fasterxml.jackson.databind.JsonNode</code> 表示一个 JSON 节点，可以通过 <code>ObjectMapper#readTree</code> 方法解析出来，也可以通过 <code>JsonNode</code> 的子类 API 自定义构建：</p>
<p><img src="/img/java/jackson/JsonNode.png" alt="JsonNode"></p>
<p>构建代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">JsonNode jsonNode =</span><br><span class="line">    <span class="keyword">new</span> ObjectNode(JsonNodeFactory.instance, ImmutableMap.of(</span><br><span class="line">        <span class="string">"hello"</span>,</span><br><span class="line">        <span class="keyword">new</span> ArrayNode(JsonNodeFactory.instance, ImmutableList.of(</span><br><span class="line">            <span class="keyword">new</span> ObjectNode(JsonNodeFactory.instance, ImmutableMap.of(<span class="string">"key"</span>, <span class="keyword">new</span> TextNode(<span class="string">"value0"</span>))),</span><br><span class="line">            <span class="keyword">new</span> ObjectNode(JsonNodeFactory.instance, ImmutableMap.of(<span class="string">"key"</span>, <span class="keyword">new</span> TextNode(<span class="string">"value1"</span>))),</span><br><span class="line">            <span class="keyword">new</span> ObjectNode(JsonNodeFactory.instance, ImmutableMap.of(<span class="string">"key2"</span>, <span class="keyword">new</span> TextNode(<span class="string">"value2"</span>)))</span><br><span class="line">        )),</span><br><span class="line">        <span class="string">"test"</span>,</span><br><span class="line">        <span class="keyword">new</span> ObjectNode(JsonNodeFactory.instance, ImmutableMap.of(</span><br><span class="line">            <span class="string">"key3"</span>, <span class="keyword">new</span> TextNode(<span class="string">"value3"</span>)))));</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;"hello":[&#123;"key":"value0"&#125;,&#123;"key":"value1"&#125;,&#123;"key2":"value2"&#125;],"test":&#123;"key3":"value3"&#125;&#125;</span></span><br><span class="line">log.info(jsonNode.toString());</span><br></pre></td></tr></table></figure>

<p><code>JsonNode</code> 构建完成后，可以灵活的读取其值，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [value0, value1]</span></span><br><span class="line">log.info(jsonNode.get(<span class="string">"hello"</span>).findValuesAsText(<span class="string">"key"</span>).toString());</span><br><span class="line"><span class="comment">// value3</span></span><br><span class="line">log.info(jsonNode.get(<span class="string">"test"</span>).get(<span class="string">"key3"</span>).asText());</span><br></pre></td></tr></table></figure>
<h1 id="ObjectMapper-工具类"><a href="#ObjectMapper-工具类" class="headerlink" title="ObjectMapper 工具类"></a>ObjectMapper 工具类</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.type.TypeReference;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.*;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.UtilityClass;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * jackson工具类</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@UtilityClass</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectMapper OBJECT_MAPPER = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">//false: 空对象不抛异常 e.g. handler&#123; &#125;</span></span><br><span class="line">        OBJECT_MAPPER.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//false: 解析JSON时忽略未知属性</span></span><br><span class="line">        OBJECT_MAPPER.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//true :空字符串可以解析为空对象</span></span><br><span class="line">        OBJECT_MAPPER.configure(DeserializationFeature.ACCEPT_EMPTY_STRING_AS_NULL_OBJECT, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ObjectMapper <span class="title">getObjectMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> OBJECT_MAPPER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj POJO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 泛型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> JSON</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">String <span class="title">toJson</span><span class="params">(T obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getObjectMapper().writeValueAsString(obj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"to json failure"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text JSON</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type Class&lt;?&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;  泛型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> POJO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">fromJson</span><span class="params">(String text, Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getObjectMapper().readValue(text, type);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">"fromJson failure"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JsonNode <span class="title">fromJson</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getObjectMapper().readTree(text);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">"from json failure"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">fromJson</span><span class="params">(String text, JavaType javaType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getObjectMapper().readValue(text, javaType);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">"from json failure"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">fromJson</span><span class="params">(String text, TypeReference&lt;T&gt; valueTypeRef)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getObjectMapper().readValue(text, valueTypeRef);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">"from json failure"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> src  JSON字节</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type Class&lt;?&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;  泛型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> POJO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">fromByte</span><span class="params">(<span class="keyword">byte</span>[] src, Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getObjectMapper().readValue(src, OBJECT_MAPPER.constructType(type));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">"from byte failure"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map  Map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type Class&lt;?&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;  泛型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> POJO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">fromMap</span><span class="params">(Map&lt;String, Object&gt; map, Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getObjectMapper().convertValue(map, OBJECT_MAPPER.getTypeFactory().constructType(type));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            log.error(<span class="string">"fromMap failure"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text JSON</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type Class&lt;?&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;  T</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> List</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">fromJsonToList</span><span class="params">(String text, Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//     fromJson(java.lang.String, com.fasterxml.jackson.databind.JavaType)</span></span><br><span class="line">        <span class="keyword">return</span> fromJson(text, OBJECT_MAPPER.getTypeFactory().constructParametricType(ArrayList<span class="class">.<span class="keyword">class</span>, <span class="title">type</span>))</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="JavaType-的使用"><a href="#JavaType-的使用" class="headerlink" title="JavaType 的使用"></a>JavaType 的使用</h1><p>工具类的方法 <code>fromJsonToList</code>，使用了方法 <code>OBJECT_MAPPER.getTypeFactory().constructParametricType(...)</code>，其值调试如下：</p>
<p><img src="/img/java/jackson/CollectionType.png" alt=""></p>
<p>这个值为 <code>JavaType</code> 的子类 <code>CollectionType</code>，可用于调用方法 <code>ObjectMapper#readValue(java.lang.String, com.fasterxml.jackson.databind.JavaType)</code> 进行集合类型的 JSON 转换：</p>
<p><img src="/img/java/jackson/JavaType.png" alt="JavaType"></p>
<h1 id="使用例子"><a href="#使用例子" class="headerlink" title="使用例子"></a>使用例子</h1><p>本例中，我们需要获取以下两个方法的泛型返回值中的实际类型参数 <code>XxxRespDTO</code> 的 <code>Class</code> 类型，以用于 JSON 转换：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApiService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接口一</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">RespDTO&lt;XxxRespDTO&gt; <span class="title">get</span><span class="params">(XxxReqDTO reqDTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接口二</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RespDTO&lt;List&lt;XxxRespDTO&gt;&gt; list(XxxReqDTO reqDTO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义一个方法，用于转换 JSON：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getObject</span><span class="params">(Method method, String json)</span> </span>&#123;</span><br><span class="line">    Object result;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取该方法的泛型返回值，然后获取其第一个实际类型参数</span></span><br><span class="line">    ParameterizedType returnType = (ParameterizedType) method.getGenericReturnType();</span><br><span class="line">    Type type = returnType.getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理接口一的情况</span></span><br><span class="line">    <span class="keyword">if</span> (type <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = (Class&lt;?&gt;) type;</span><br><span class="line">        result = JsonUtils.fromJson(json, clazz);  <span class="comment">// ObjectMapper#readValue(String, Class&lt;T&gt;)</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">        ParameterizedType nestedReturnType = (ParameterizedType) type;</span><br><span class="line">        <span class="comment">// 处理接口二的情况</span></span><br><span class="line">        <span class="keyword">if</span> (nestedReturnType.getRawType() == List<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            Class&lt;?&gt; clazz = (Class&lt;?&gt;) nestedReturnType.getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line">            result = JsonUtils.fromJsonToList(decryptedRespData, clazz);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"未实现的 JSON 解析！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"未实现的 JSON 解析！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种用法常常出现在框架之中。下面来看下调试效果：</p>
<h2 id="接口一"><a href="#接口一" class="headerlink" title="接口一"></a>接口一</h2><p>下图展示了变量 <code>returnType</code> 为参数化类型 <code>ParameterizedType</code>，其实际类型参数 <code>type</code> 为 <code>Class</code> 类型，值为 <code>XxxRespDTO</code> ：</p>
<p><img src="/img/java/jackson/ObjectMapper_example.png" alt="JsonNode"></p>
<h2 id="接口二"><a href="#接口二" class="headerlink" title="接口二"></a>接口二</h2><p>下图展示了变量 <code>returnType</code> 的实际类型参数 <code>type</code> 与接口一为 <code>Class</code> 类型不同，接口二为 <code>ParameterizedType</code> 参数化类型，值为 <code>List&lt;XxxRespDTO&gt;</code>：</p>
<p><img src="/img/java/jackson/ObjectMapper_example_2.png" alt=""></p>
<h1 id="常见报错"><a href="#常见报错" class="headerlink" title="常见报错"></a>常见报错</h1><h2 id="Unrecognized-field-not-marked-as-ignorable"><a href="#Unrecognized-field-not-marked-as-ignorable" class="headerlink" title="Unrecognized field, not marked as ignorable"></a>Unrecognized field, not marked as ignorable</h2><p>该错误的意思是说，不能够识别的字段没有标示为可忽略。出现该问题的原因就是 JSON 中包含了目标 Java 对象没有的属性。</p>
<p>解决方法有如下几种：</p>
<ol>
<li>保证传入的 JSON 串不包含目标对象的没有的属性。</li>
<li><code>@JsonIgnoreProperties(ignoreUnknown = true)</code> 在目标对象的类级别上加上该注解和属性，则 Jackson 在反序列化的时候，会忽略该目标对象不存在的属性。</li>
<li>全局 <code>DeserializationFeature</code> 配置<br><code>objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES,false)</code> 配置该 <code>objectMapper</code> 在反序列化时，忽略目标对象没有的属性。凡是使用该 <code>objectMapper</code> 反序列化时，都会拥有该特性。</li>
</ol>
</div></article></li></ul><div class="right-container"><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/DNS/" style="font-size: 12.5px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/GNU-Linux/" style="font-size: 16.67px;">GNU/Linux</a> <a href="/tags/Git/" style="font-size: 17.5px;">Git</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/MySQL/" style="font-size: 19.17px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 11.67px;">Nginx</a> <a href="/tags/Redis/" style="font-size: 10.83px;">Redis</a> <a href="/tags/Spring/" style="font-size: 15.83px;">Spring</a> <a href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">函数式编程</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 18.33px;">前端</a> <a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">响应式编程</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 12.5px;">安全</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">并发编程</a> <a href="/tags/%E5%BB%BA%E7%AB%99/" style="font-size: 13.33px;">建站</a> <a href="/tags/%E7%AE%A1%E7%90%86/" style="font-size: 12.5px;">管理</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 14.17px;">读书笔记</a> <a href="/tags/%E9%87%91%E8%9E%8D/" style="font-size: 12.5px;">金融</a></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/02/26/cpp-io-library/">C/C++ 语言系列（十一）I/O 库总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/25/cpp-oop-inheritance-and-polymorphism/">C/C++ 语言系列（十）面向对象编程之继承与多态</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/20/cpp-oop-class/">C/C++ 语言系列（九）面向对象编程之类、类模板、类指针</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/18/cpp-type-aliases/">C/C++ 语言系列（八）复合数据类型之类型别名</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/16/cpp-struct/">C/C++ 语言系列（七）复合数据类型之结构体</a></li></ul></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/page/11/" class="prev">PREV</a><a href="/page/13/" class="next">NEXT</a></div><div class="copyright"><p>© 2014 - 2021 <a href="https://github.com/qidawu" target="_blank">Qida's Blog</a></p><p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/scripts/jquery-1.8.2.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script></body></html>