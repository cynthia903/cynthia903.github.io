<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> Nginx 反向代理 · Qida's Blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Nginx 反向代理 - Qida's Blog"><meta name="keywords"><meta name="author" content="Qida's Blog"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://qidawu.github.io/atom.xml" title="Qida's Blog"><meta name="generator" content="Hexo 4.2.1"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><a href="/" class="title-link">Qida's Blog</a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">Nginx 反向代理</h1><div class="post-info">2017-05-06<a href="/tags/Nginx/" title="Nginx" class="post-demo">Nginx</a></div><div class="post-content"><h1 id="什么是代理？"><a href="#什么是代理？" class="headerlink" title="什么是代理？"></a>什么是代理？</h1><p>一张图了解两种代理模式的区别：</p>
<p><img src="/img/nginx/proxy.jpg" alt="两种代理模式"></p>
<p>常见应用场景：</p>
<ul>
<li>正向代理：VPN 翻墙</li>
<li>反向代理：Web 站点服务</li>
</ul>
<h1 id="Nginx-反向代理"><a href="#Nginx-反向代理" class="headerlink" title="Nginx 反向代理"></a>Nginx 反向代理</h1><p>Nginx 代理功能由标准 HTTP 模块中内置的 <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" target="_blank" rel="noopener">ngx_http_proxy_module</a> 提供，因此无需额外编译，常见配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        server_name example.com;</span><br><span class="line">        listen 80;</span><br><span class="line">        </span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;127.0.0.1:81&#x2F;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>proxy_pass</code> 指令用于配置被代理服务器的协议和地址。除了配置单机，还可以配置集群，详见 <a href="/2017/05/13/nginx-upstream/">Nginx 负载均衡</a> 。</p>
<h1 id="解决代理后的问题"><a href="#解决代理后的问题" class="headerlink" title="解决代理后的问题"></a>解决代理后的问题</h1><h2 id="上游无法获取真实的访问来源信息"><a href="#上游无法获取真实的访问来源信息" class="headerlink" title="上游无法获取真实的访问来源信息"></a>上游无法获取真实的访问来源信息</h2><p>使用反向代理之后，上游服务器（如 Tomcat）无法获取真实的访问来源信息（如协议、域名、访问 IP），例如下面代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request.getScheme() <span class="comment">// 总是 http，而不是实际的 http 或 https</span></span><br><span class="line">request.isSecure() <span class="comment">// 总是 false</span></span><br><span class="line">request.getRemoteAddr() <span class="comment">// Nginx IP</span></span><br><span class="line">request.getServerName() <span class="comment">// 127.0.0.1</span></span><br><span class="line">request.getRequestURL() <span class="comment">// http://127.0.0.1:81/index</span></span><br><span class="line">response.sendRedirect(...) <span class="comment">// 总是重定向到 http</span></span><br></pre></td></tr></table></figure>

<p>这个问题需要在 Nginx 和 Tomcat 中做一些配置以解决问题。</p>
<p>Nginx 配置：</p>
<p>使用 <code>proxy_set_header</code> 指令为上游服务器添加请求头：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    proxy_set_header Host              $host;</span><br><span class="line">    proxy_set_header X-Real-IP         $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Tomcat 配置：</p>
<p>在 Tomcat 的 <code>server.xml</code> 中配置 <a href="http://tomcat.apache.org/tomcat-7.0-doc/api/org/apache/catalina/valves/RemoteIpValve.html" target="_blank" rel="noopener">RemoteIpValve</a> 让代码能够获取真实 IP 和协议：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Valve className&#x3D;&quot;org.apache.catalina.valves.RemoteIpValve&quot; </span><br><span class="line">    remoteIpHeader&#x3D;&quot;X-Forwarded-For&quot; </span><br><span class="line">    protocolHeader&#x3D;&quot;X-Forwarded-Proto&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>解决结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">request.getScheme() <span class="comment">// 实际的 http 或 https</span></span><br><span class="line">request.isSecure() <span class="comment">// 对应的 false 或 true</span></span><br><span class="line">request.getRemoteAddr() <span class="comment">// 用户 IP</span></span><br><span class="line">request.getHeader(<span class="string">"X-Real-IP"</span>) <span class="comment">// 用户 IP</span></span><br><span class="line">request.getServerName() <span class="comment">// example.com</span></span><br><span class="line">request.getRequestURL() <span class="comment">// 对应的 http://example.com/index 或 https://example.com/index</span></span><br><span class="line">response.sendRedirect(...) <span class="comment">// 实际的 http 或 https</span></span><br></pre></td></tr></table></figure>

<h2 id="全局-proxy-set-header-失效"><a href="#全局-proxy-set-header-失效" class="headerlink" title="全局 proxy_set_header 失效"></a>全局 proxy_set_header 失效</h2><p>先来看下 <code>proxy_set_header</code> 的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">语法:	proxy_set_header field value;</span><br><span class="line">默认值: proxy_set_header Host $proxy_host;</span><br><span class="line">        proxy_set_header Connection close;</span><br><span class="line">上下文: http, server, location</span><br><span class="line"></span><br><span class="line">允许重新定义或者添加发往后端服务器的请求头。value 可以包含文本、变量或者它们的组合。当且仅当当前配置级别中没有定义 proxy_set_header 指令时，会从上面的级别继承配置。 默认情况下，只有两个请求头会被重新定义：</span><br><span class="line"></span><br><span class="line">proxy_set_header Host       $proxy_host;</span><br><span class="line">proxy_set_header Connection close;</span><br></pre></td></tr></table></figure>

<p>这里隐含一个坑：<strong>如果当前配置级别中定义了 <code>proxy_set_header</code> 指令，哪怕只配置了一个，都会导致无法从上面的级别继承配置</strong>，即导致全局级别的 <code>proxy_set_header</code> 配置失效。例如下述 HTTP <a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive" target="_blank" rel="noopener">长连接配置</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    proxy_set_header Host              $host;</span><br><span class="line">    proxy_set_header X-Real-IP         $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line"></span><br><span class="line">    upstream backend &#123;</span><br><span class="line">        server 127.0.0.1:8080;</span><br><span class="line">        keepalive 16;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;backend;</span><br><span class="line">            proxy_http_version 1.1;</span><br><span class="line">            proxy_set_header Connection &quot;&quot;;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>导致全局级别的 <code>proxy_set_header</code> 配置失效：</p>
<p><img src="/img/nginx/problem_of_proxy_set_header.png" alt="proxy_set_header 失效"></p>
<p>解决办法是在 <code>location</code> 中重新配置这四个请求头。</p>
</div></article></div><div class="right-container"><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/DNS/" style="font-size: 12.5px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/GNU-Linux/" style="font-size: 16.67px;">GNU/Linux</a> <a href="/tags/Git/" style="font-size: 17.5px;">Git</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/MySQL/" style="font-size: 19.17px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 11.67px;">Nginx</a> <a href="/tags/Redis/" style="font-size: 10.83px;">Redis</a> <a href="/tags/Spring/" style="font-size: 15.83px;">Spring</a> <a href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">函数式编程</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 18.33px;">前端</a> <a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">响应式编程</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 12.5px;">安全</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">并发编程</a> <a href="/tags/%E5%BB%BA%E7%AB%99/" style="font-size: 13.33px;">建站</a> <a href="/tags/%E7%AE%A1%E7%90%86/" style="font-size: 12.5px;">管理</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 14.17px;">读书笔记</a> <a href="/tags/%E9%87%91%E8%9E%8D/" style="font-size: 12.5px;">金融</a></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2017/05/07/nginx-ssl/" class="prev">PREV</a><a href="/2017/05/01/maven-build-lifecycle/" class="next">NEXT</a></div><div class="copyright"><p>© 2014 - 2021 <a href="https://github.com/qidawu" target="_blank">Qida's Blog</a></p><p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/scripts/jquery-1.8.2.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script></body></html>