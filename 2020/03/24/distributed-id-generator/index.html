<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> 分布式 ID 之雪花算法实现 · Qida's Blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="分布式 ID 之雪花算法实现 - Qida's Blog"><meta name="keywords"><meta name="author" content="Qida's Blog"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://qidawu.github.io/atom.xml" title="Qida's Blog"><meta name="generator" content="Hexo 4.2.1"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><a href="/" class="title-link">Qida's Blog</a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">分布式 ID 之雪花算法实现</h1><div class="post-info">2020-03-24<a href="/tags/Java/" title="Java" class="post-demo">Java</a></div><div class="post-content"><h1 id="雪花算法介绍"><a href="#雪花算法介绍" class="headerlink" title="雪花算法介绍"></a>雪花算法介绍</h1><p>雪花算法（Snowflake）是 Twitter 提出来的一个算法，其目的是生成一个 64 bit 的整数：</p>
<p><img src="/img/distribute/Snowflake.png" alt="Snowflake"></p>
<p>转换为十进制和十六进制如下。其中十进制的最大长度为 19 位：</p>
<p><img src="/img/distribute/max_id.png" alt=""></p>
<p>其中：</p>
<ul>
<li><p>42 bit：用来记录时间戳，表示自 1970-01-01T00:00:00Z 之后经过的毫秒数，其中 1 bit 是符号位。由于精确到毫秒，相比有符号 32 bit 整型所存储的时间戳需要多 10 bit 来记录毫秒数（0-999）。42 bit 可以记录 69 年，如果设置好起始时间比如今年是2018年，那么可以用到2089年。42 bit 时间戳范围如下：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="keyword">long</span> a = <span class="number">0b00_00000000_00000000_00000000_00000000_00000000L</span>;</span><br><span class="line"><span class="comment">// 999</span></span><br><span class="line"><span class="keyword">long</span> b = <span class="number">0b00_00000000_00000000_00000000_00000011_11100111L</span>;</span><br><span class="line"><span class="comment">// 2^41-1, 2199023255551</span></span><br><span class="line"><span class="keyword">long</span> c = <span class="number">0b01_11111111_11111111_11111111_11111111_11111111L</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1970-01-01T00:00:00.000Z</span></span><br><span class="line">Instant.ofEpochMilli(a).atZone(ZoneOffset.of(<span class="string">"-00:00"</span>)).toLocalDateTime();</span><br><span class="line"><span class="comment">// 1970-01-01T00:00:00.999Z</span></span><br><span class="line">Instant.ofEpochMilli(b).atZone(ZoneOffset.of(<span class="string">"-00:00"</span>)).toLocalDateTime();</span><br><span class="line"><span class="comment">// 2039-09-07T15:47:35.551Z</span></span><br><span class="line">Instant.ofEpochMilli(c).atZone(ZoneOffset.of(<span class="string">"-00:00"</span>)).toLocalDateTime();</span><br></pre></td></tr></table></figure>
</li>
<li><p>10 bit：用来记录机器 ID，总共可以记录 1024 台机器，一般用前 5 位代表数据中心，后面 5 位是某个数据中心的机器 ID</p>
</li>
<li><p>12 bit：循环位，用来对同一个毫秒之内产生不同的 ID，12 位可以最多记录 4095 个，也就是在同一个机器同一毫秒最多记录 4095 个，多余的需要进行等待下个毫秒。</p>
</li>
</ul>
<p>上面只是一个将 64 bit 划分的标准，当然也不一定这么做，可以根据不同业务的具体场景来划分，比如下面给出一个业务场景：</p>
<ul>
<li>服务目前 QPS10 万，预计几年之内会发展到百万。</li>
<li>当前机器三地部署，上海，北京，深圳都有。</li>
<li>当前机器 10 台左右，预计未来会增加至百台。</li>
</ul>
<p>这个时候我们根据上面的场景可以再次合理的划分 64 bit，QPS几年之内会发展到百万，那么每毫秒就是千级的请求，目前10台机器那么每台机器承担百级的请求（100 W / 1000 ms / 10 台）。为了保证扩展，后面的循环位可以限制到 1024，也就是 2^10，那么循环位 10 位就足够了。</p>
<p>机器三地部署我们可以用 3 bit 总共 8 来表示机房位置；当前机器 10 台，为了保证能够扩展到百台那么可以用 7 bit 总共 128 来表示；时间位依然是 42 bit。那么还剩下 64-10-3-7-42 = 2 bit，剩下 2 bit 可以用来进行扩展。</p>
<h1 id="雪花算法实现"><a href="#雪花算法实现" class="headerlink" title="雪花算法实现"></a>雪花算法实现</h1><p>下面是我的对雪花算法的实现，涉及几点思考：</p>
<ol>
<li>为了节省空间、提升运算性能，主要使用到位运算，而不是字符串操作。</li>
<li>为了提高可配置性，将每一部分的位数抽取成了常量，以便自定义。</li>
<li>解决时间回拨问题。如果回拨时长较短（可配置，代码中配了 5 ms），线程等待；如果较长，则利用扩展位避免生成重复 ID（扩展位可配，代码中配置了 3 位，即最多支持 3 次回拨，超出则抛异常）。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.ZoneId;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.assertEquals;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IdGeneratorTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> initialCapacity = <span class="number">1000</span>;</span><br><span class="line">        Set&lt;Long&gt; ids = <span class="keyword">new</span> HashSet&lt;&gt;(initialCapacity);</span><br><span class="line">        IdGenerator idGenerator = <span class="keyword">new</span> IdGenerator(<span class="number">3</span>, <span class="number">31</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; initialCapacity; i++) &#123;</span><br><span class="line">            <span class="keyword">long</span> id = idGenerator.nextId();</span><br><span class="line">            ids.add(id);</span><br><span class="line"></span><br><span class="line">            IdGenerator.log(id);</span><br><span class="line">        &#125;</span><br><span class="line">        assertEquals(ids.size(), initialCapacity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IdGenerator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 时间戳</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> timestamp;</span><br><span class="line">    <span class="comment">// 数据中心</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> dataCenterNo;</span><br><span class="line">    <span class="comment">// 机器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> workerNo;</span><br><span class="line">    <span class="comment">// 序列号</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> seqNo;</span><br><span class="line">    <span class="comment">// 扩展位</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据中心 取值范围（十进制）：0~3</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DATA_CENTER_NO_BITS = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 机器 取值范围（十进制）：0~31</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WORKER_NO_BITS = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">// 序列号 取值范围（十进制）：0~4095</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SEQ_NO_BITS = <span class="number">12</span>;</span><br><span class="line">    <span class="comment">// 扩展位 取值范围（十进制）：0~7</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXT_BITS = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据中心 最大值（十进制）：3</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_DATA_CENTER_NO = (<span class="number">1</span> &lt;&lt; DATA_CENTER_NO_BITS) - <span class="number">0B1</span>;</span><br><span class="line">    <span class="comment">// 机器 最大值（十进制）：31</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_WORKER_NO = (<span class="number">1</span> &lt;&lt; WORKER_NO_BITS) - <span class="number">0B1</span>;</span><br><span class="line">    <span class="comment">// 序列号 最大值（十进制）：4095</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_SEQ_NO = (<span class="number">1</span> &lt;&lt; SEQ_NO_BITS) - <span class="number">0B1</span>;</span><br><span class="line">    <span class="comment">// 扩展位 最大值（十进制）：7</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_EXT = (<span class="number">1</span> &lt;&lt; EXT_BITS) - <span class="number">0B1</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 时间戳 左移 22 位</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIMESTAMP_SHIFT = DATA_CENTER_NO_BITS + WORKER_NO_BITS + SEQ_NO_BITS + EXT_BITS;</span><br><span class="line">    <span class="comment">// 数据中心 左移 20 位</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DATA_CENTER_NO_SHIFT = WORKER_NO_BITS + SEQ_NO_BITS + EXT_BITS;</span><br><span class="line">    <span class="comment">// 机器 左移 15 位</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WORKER_NO_SHIFT = SEQ_NO_BITS + EXT_BITS;</span><br><span class="line">    <span class="comment">// 序列号 左移 3 位</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SEQ_NO_SHIFT = EXT_BITS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最大回拨毫秒数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_BACKWARD_MILLIS = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataCenterNo 数据中心编号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> workerNo 机器编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IdGenerator</span><span class="params">(<span class="keyword">int</span> dataCenterNo, <span class="keyword">int</span> workerNo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Integer.toBinaryString(dataCenterNo).length() &gt; DATA_CENTER_NO_BITS) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(<span class="string">"当前数据中心编号 %s 超限，最大支持 %s"</span>, dataCenterNo, MAX_DATA_CENTER_NO));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Integer.toBinaryString(workerNo).length() &gt; WORKER_NO_BITS) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(<span class="string">"当前机器编号 %s 超限，最大支持 %s"</span>, workerNo, MAX_WORKER_NO));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.dataCenterNo = dataCenterNo;</span><br><span class="line">        <span class="keyword">this</span>.workerNo = workerNo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成分布式 ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 分布式 ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> <span class="title">nextId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// init or reset</span></span><br><span class="line">        <span class="keyword">if</span> (timestamp == <span class="number">0</span> || timestamp &lt; now) &#123;</span><br><span class="line">            timestamp = now;</span><br><span class="line">            seqNo = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// seqNo increment</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (timestamp == now) &#123;</span><br><span class="line">            <span class="keyword">if</span> (seqNo &lt; MAX_SEQ_NO) &#123;</span><br><span class="line">                seqNo++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.warn(<span class="string">"序列号已耗尽，等待重新生成。seqNo = &#123;&#125;, MAX_SEQ_NO = &#123;&#125;"</span>, seqNo, MAX_SEQ_NO);</span><br><span class="line">                <span class="keyword">return</span> sleepAndNextId(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// clock backward</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> nextIdForBackward(now);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> timestamp &lt;&lt; TIMESTAMP_SHIFT</span><br><span class="line">                | dataCenterNo &lt;&lt; DATA_CENTER_NO_SHIFT</span><br><span class="line">                | workerNo &lt;&lt; WORKER_NO_SHIFT</span><br><span class="line">                | seqNo &lt;&lt; SEQ_NO_SHIFT</span><br><span class="line">                | ext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">nextIdForBackward</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">        log.warn(<span class="string">"发生时间回拨，timestamp = &#123;&#125;, now = &#123;&#125;"</span>, timestamp, now);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> duration = timestamp - now;</span><br><span class="line">        <span class="comment">// 回拨不多，直接等待并重试</span></span><br><span class="line">        <span class="keyword">if</span> (duration &lt;= MAX_BACKWARD_MILLIS) &#123;</span><br><span class="line">            <span class="keyword">return</span> sleepAndNextId(duration);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 回拨过多，则使用扩展位</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ext &lt; MAX_EXT) &#123;</span><br><span class="line">                <span class="comment">// 将时间戳修正为回拨时间，为防止重复生成 ID，扩展位加一，并重试</span></span><br><span class="line">                ext++;</span><br><span class="line">                timestamp = now;</span><br><span class="line">                <span class="keyword">return</span> nextId();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"扩展位已耗尽。ext = %s, MAX_EXT = %s"</span>, ext, MAX_EXT));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">sleepAndNextId</span><span class="params">(<span class="keyword">long</span> millis)</span> </span>&#123;</span><br><span class="line">        Thread.sleep(millis);</span><br><span class="line">        <span class="keyword">return</span> nextId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> timestamp = id &gt;&gt; TIMESTAMP_SHIFT;</span><br><span class="line">        <span class="keyword">long</span> dataCenterNo = id &gt;&gt; DATA_CENTER_NO_SHIFT &amp; MAX_DATA_CENTER_NO;</span><br><span class="line">        <span class="keyword">long</span> workerNo = id &gt;&gt; WORKER_NO_SHIFT &amp; MAX_WORKER_NO;</span><br><span class="line">        <span class="keyword">long</span> seqNo = id &gt;&gt; SEQ_NO_SHIFT &amp; MAX_SEQ_NO;</span><br><span class="line">        <span class="keyword">long</span> ext = id &amp; MAX_EXT;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"Binary is &#123;&#125;, id is &#123;&#125;"</span>, Long.toBinaryString(id), id);</span><br><span class="line">        log.info(<span class="string">"Binary is &#123;&#125;, time is &#123;&#125;"</span>, Long.toBinaryString(timestamp), getLocalDateTime(timestamp));</span><br><span class="line">        log.info(<span class="string">"Binary is &#123;&#125;, dataCenterNo is &#123;&#125;"</span>, Long.toBinaryString(dataCenterNo), dataCenterNo);</span><br><span class="line">        log.info(<span class="string">"Binary is &#123;&#125;, workerNo is &#123;&#125;"</span>, Long.toBinaryString(workerNo), workerNo);</span><br><span class="line">        log.info(<span class="string">"Binary is &#123;&#125;, seqNo is &#123;&#125;"</span>, Long.toBinaryString(seqNo), seqNo);</span><br><span class="line">        log.info(<span class="string">"Binary is &#123;&#125;, ext is &#123;&#125;"</span>, Long.toBinaryString(ext), ext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> LocalDateTime <span class="title">getLocalDateTime</span><span class="params">(<span class="keyword">long</span> timestamp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Instant.ofEpochMilli(timestamp).atZone(ZoneId.systemDefault()).toLocalDateTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Binary is 101111000100100011111011111000111010101011111111000000000000000, id is 6783685416349302784</span><br><span class="line">&#x2F;&#x2F; Binary is 10111100010010001111101111100011101010101, time is 2021-04-02T17:43:58.037</span><br><span class="line">&#x2F;&#x2F; Binary is 11, dataCenterNo is 3</span><br><span class="line">&#x2F;&#x2F; Binary is 11111, workerNo is 31</span><br><span class="line">&#x2F;&#x2F; Binary is 0, seqNo is 0</span><br><span class="line">&#x2F;&#x2F; Binary is 0, ext is 0</span><br></pre></td></tr></table></figure>

<p>二进制分段如下：<code>10111100010010001111101111100011101010101_11_11111_000000000000_000</code></p>
<h1 id="延伸阅读：位运算"><a href="#延伸阅读：位运算" class="headerlink" title="延伸阅读：位运算"></a>延伸阅读：位运算</h1><p>位运算符如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&amp;：按位与。</span><br><span class="line">|：按位或。</span><br><span class="line">~：按位非。</span><br><span class="line">^：按位异或。</span><br><span class="line">&lt;&lt;：左位移运算符（M &lt;&lt; n &#x3D; M * 2^n）。</span><br><span class="line">&gt;&gt;：右位移运算符（M &gt;&gt; n &#x3D; M &#x2F; 2*n）。</span><br><span class="line">&gt;&gt;&gt;：无符号右移运算符。</span><br></pre></td></tr></table></figure>

<p>例如，Java 中求 key 应当放到散列表的哪个位置（offset）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getOffset</span><span class="params">(Object key, <span class="keyword">int</span> length)</span> </span></span><br><span class="line"><span class="function">    <span class="keyword">int</span> hashcode</span>;</span><br><span class="line">    <span class="keyword">int</span> hash = (hashcode = key.hashCode()) ^ (hashcode &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">int</span> offset = hash &amp; (length - <span class="number">1</span>);</span><br><span class="line">    log.info(<span class="string">"key: &#123;&#125;, hashcode: &#123;&#125;, hash: &#123;&#125;, offset: &#123;&#125;"</span>, key, Integer.toBinaryString(hashcode), Integer.toBinaryString(hash), offset);</span><br><span class="line">    <span class="keyword">return</span> offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<ul>
<li><a href="https://www.cnblogs.com/SunArmy/p/9837348.html" target="_blank" rel="noopener">《Java 位运算符 &amp;、|、^、~、&lt;&lt;、&gt;&gt;、&gt;&gt;&gt;》</a></li>
<li><a href="https://blog.csdn.net/qq_39705793/article/details/81237005" target="_blank" rel="noopener">《异或的用途》</a></li>
</ul>
<h1 id="UNIX-时间戳"><a href="#UNIX-时间戳" class="headerlink" title="UNIX 时间戳"></a>UNIX 时间戳</h1><p>参考：<a href="/2020/02/28/unix-timestamp/">UNIX 时间戳总结</a></p>
</div></article></div><div class="right-container"><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/DNS/" style="font-size: 12.5px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/GNU-Linux/" style="font-size: 16.67px;">GNU/Linux</a> <a href="/tags/Git/" style="font-size: 17.5px;">Git</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/MySQL/" style="font-size: 19.17px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 11.67px;">Nginx</a> <a href="/tags/Redis/" style="font-size: 10.83px;">Redis</a> <a href="/tags/Spring/" style="font-size: 15.83px;">Spring</a> <a href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">函数式编程</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 18.33px;">前端</a> <a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">响应式编程</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 12.5px;">安全</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">并发编程</a> <a href="/tags/%E5%BB%BA%E7%AB%99/" style="font-size: 13.33px;">建站</a> <a href="/tags/%E7%AE%A1%E7%90%86/" style="font-size: 12.5px;">管理</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 14.17px;">读书笔记</a> <a href="/tags/%E9%87%91%E8%9E%8D/" style="font-size: 12.5px;">金融</a></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2020/04/25/relational-data-model/" class="prev">PREV</a><a href="/2020/02/28/unix-timestamp/" class="next">NEXT</a></div><div class="copyright"><p>© 2014 - 2021 <a href="https://github.com/qidawu" target="_blank">Qida's Blog</a></p><p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/scripts/jquery-1.8.2.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script></body></html>