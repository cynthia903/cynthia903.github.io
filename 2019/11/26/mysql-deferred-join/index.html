<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> MySQL 延迟关联优化超多分页场景 · Qida's Blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="MySQL 延迟关联优化超多分页场景 - Qida's Blog"><meta name="keywords"><meta name="author" content="Qida's Blog"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://qidawu.github.io/atom.xml" title="Qida's Blog"><meta name="generator" content="Hexo 4.2.1"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><a href="/" class="title-link">Qida's Blog</a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">MySQL 延迟关联优化超多分页场景</h1><div class="post-info">2019-11-26<a href="/tags/MySQL/" title="MySQL" class="post-demo">MySQL</a></div><div class="post-content"><h1 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h1><p>场景：</p>
<ul>
<li>订单表数据量：3000 万。</li>
<li>查询最近 7 天的订单，并做分页、分片。</li>
</ul>
<p>表结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_order`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`order_no`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uk_order_no`</span> (<span class="string">`order_no`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_create_time`</span> (<span class="string">`create_time`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</span><br></pre></td></tr></table></figure>

<p>超多分页场景如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> t_order </span><br><span class="line"><span class="keyword">where</span> create_time <span class="keyword">between</span> <span class="string">'2019-10-17'</span> <span class="keyword">and</span> <span class="string">'2019-10-25'</span> </span><br><span class="line"><span class="keyword">limit</span> <span class="number">1000000</span>, <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">+<span class="comment">----+-------------+---------+-------+-----------------+-----------------+---------+------+---------+-----------------------+</span></span><br><span class="line">| id | select_type | table   | type  | possible_keys   | key             | key_len | ref  | rows    | Extra                 |</span><br><span class="line">+<span class="comment">----+-------------+---------+-------+-----------------+-----------------+---------+------+---------+-----------------------+</span></span><br><span class="line">|  1 | SIMPLE      | t_order | range | idx_create_time | idx_create_time | 5       | NULL | 3775048 | Using index condition |</span><br><span class="line">+<span class="comment">----+-------------+---------+-------+-----------------+-----------------+---------+------+---------+-----------------------+</span></span><br></pre></td></tr></table></figure>

<p>虽然走了 <code>idx_create_time</code> 索引，但仍然是个慢查询，扫描行数过多。</p>
<h1 id="超多分页的问题是什么？"><a href="#超多分页的问题是什么？" class="headerlink" title="超多分页的问题是什么？"></a>超多分页的问题是什么？</h1><blockquote>
<p>随着偏移量 <code>offset</code> 的增加，MySQL 需要花费大量的时间来扫描需要丢弃的数据。本质上就是 <code>offset</code> 过大导致的大量回表 I/O 查询。</p>
</blockquote>
<p>如果能减少这种大量的回表查询，就能提升查询性能。</p>
<h1 id="概念介绍"><a href="#概念介绍" class="headerlink" title="概念介绍"></a>概念介绍</h1><h2 id="什么是延迟关联优化？"><a href="#什么是延迟关联优化？" class="headerlink" title="什么是延迟关联优化？"></a>什么是延迟关联优化？</h2><p>什么是“延迟关联”？</p>
<blockquote>
<p> 通过使用覆盖索引查询返回需要的主键，再根据主键关联原表获得需要的数据。 </p>
</blockquote>
<p>参考两个材料：</p>
<p>《高性能 MySQL》P194：</p>
<p><img src="/img/mysql/deferred_join_1.png" alt="deferred_join_1"></p>
<p>《阿里巴巴 Java 开发手册》：</p>
<p><img src="/img/mysql/deferred_join_2.png" alt="deferred_join_2"></p>
<h2 id="什么是覆盖索引？"><a href="#什么是覆盖索引？" class="headerlink" title="什么是覆盖索引？"></a>什么是覆盖索引？</h2><p>查询的列被所建的辅助索引所覆盖，无需回表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t_order </span><br><span class="line"><span class="keyword">where</span> create_time <span class="keyword">between</span> <span class="string">'2019-10-17'</span> <span class="keyword">and</span> <span class="string">'2019-10-25'</span> </span><br><span class="line"><span class="keyword">limit</span> <span class="number">1000000</span>, <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">+<span class="comment">----+-------------+---------+-------+-----------------+-----------------+---------+------+---------+--------------------------+</span></span><br><span class="line">| id | select_type | table   | type  | possible_keys   | key             | key_len | ref  | rows    | Extra                    |</span><br><span class="line">+<span class="comment">----+-------------+---------+-------+-----------------+-----------------+---------+------+---------+--------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | t_order | range | idx_create_time | idx_create_time | 5       | NULL | 3775048 | Using where; Using index |</span><br><span class="line">+<span class="comment">----+-------------+---------+-------+-----------------+-----------------+---------+------+---------+--------------------------+</span></span><br></pre></td></tr></table></figure>

<p>上述查询字段改为 <code>id</code> 后，执行计划中新增： <code>Extra=Using index</code>，表示走覆盖索引，无需回表，查询速度快了 N 倍。</p>
<h1 id="延迟关联优化"><a href="#延迟关联优化" class="headerlink" title="延迟关联优化"></a>延迟关联优化</h1><p>延迟关联优化涉及到了 SQL 优化的两个重要概念：覆盖索引和回表。</p>
<ul>
<li>通过覆盖索引在辅助索引上完成所有扫描、过滤、排序（利用索引有序）和分页；</li>
<li>最后通过主键回表查询，最大限度减少回表查询的 I/O 次数。</li>
</ul>
<p>SQL 改造如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> t_order t </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t_order </span><br><span class="line">    <span class="keyword">where</span> create_time <span class="keyword">between</span> <span class="string">'2019-10-17'</span> <span class="keyword">and</span> <span class="string">'2019-10-25'</span> </span><br><span class="line">    <span class="keyword">limit</span> <span class="number">1000000</span>, <span class="number">10</span></span><br><span class="line">) e </span><br><span class="line"><span class="keyword">on</span> t.id = e.id;</span><br><span class="line"></span><br><span class="line">+<span class="comment">----+-------------+---------------+--------+-----------------+-----------------+---------+------+---------+--------------------------+</span></span><br><span class="line">| id | select_type | table         | type   | possible_keys   | key             | key_len | ref  | rows    | Extra                    |</span><br><span class="line">+<span class="comment">----+-------------+---------------+--------+-----------------+-----------------+---------+------+---------+--------------------------+</span></span><br><span class="line">|  1 | PRIMARY     | &lt;derived2&gt;    | ALL    | NULL            | NULL            | NULL    | NULL | 1000010 | NULL                     |</span><br><span class="line">|  1 | PRIMARY     | t             | eq_ref | PRIMARY         | PRIMARY         | 8       | e.id |       1 | NULL                     |</span><br><span class="line">|  2 | DERIVED     | t_order       | range  | idx_create_time | idx_create_time | 5       | NULL | 3775048 | Using where; Using index |</span><br><span class="line">+<span class="comment">----+-------------+---------------+--------+-----------------+-----------------+---------+------+---------+--------------------------+</span></span><br></pre></td></tr></table></figure>

<p>优化前：</p>
<ol>
<li>辅助索引查询，得到 id</li>
<li>id 逐一回表查询<strong>（1000000  + 10 次回表）</strong></li>
<li>查询结果放弃前 offset 行，返回 limit 行</li>
</ol>
<p>优化后：</p>
<ol>
<li>辅助查询覆盖查询，得到 id</li>
<li>查询结果放弃前 offset 行，返回 limit 行</li>
<li><strong>只需 limit 条 id 回表查询</strong>，大大减少回表查询的 I/O 次数</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://dev.mysql.com/doc/refman/5.7/en/derived-tables.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/derived-tables.html</a></p>
<p><a href="http://mysql.taobao.org/monthly/2017/03/05/" target="_blank" rel="noopener">http://mysql.taobao.org/monthly/2017/03/05/</a></p>
</div></article></div><div class="right-container"><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/DNS/" style="font-size: 12.5px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/GNU-Linux/" style="font-size: 16.67px;">GNU/Linux</a> <a href="/tags/Git/" style="font-size: 17.5px;">Git</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/MySQL/" style="font-size: 19.17px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 11.67px;">Nginx</a> <a href="/tags/Redis/" style="font-size: 10.83px;">Redis</a> <a href="/tags/Spring/" style="font-size: 15.83px;">Spring</a> <a href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">函数式编程</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 18.33px;">前端</a> <a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">响应式编程</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 12.5px;">安全</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">并发编程</a> <a href="/tags/%E5%BB%BA%E7%AB%99/" style="font-size: 13.33px;">建站</a> <a href="/tags/%E7%AE%A1%E7%90%86/" style="font-size: 12.5px;">管理</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 14.17px;">读书笔记</a> <a href="/tags/%E9%87%91%E8%9E%8D/" style="font-size: 12.5px;">金融</a></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2019/12/02/oauth2/" class="prev">PREV</a><a href="/2019/11/09/mysql-join/" class="next">NEXT</a></div><div class="copyright"><p>© 2014 - 2021 <a href="https://github.com/qidawu" target="_blank">Qida's Blog</a></p><p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/scripts/jquery-1.8.2.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script></body></html>