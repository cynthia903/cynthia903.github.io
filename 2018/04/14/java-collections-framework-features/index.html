<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> Java 集合框架系列（二）集合特性总结 · Qida's Blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Java 集合框架系列（二）集合特性总结 - Qida's Blog"><meta name="keywords"><meta name="author" content="Qida's Blog"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://qidawu.github.io/atom.xml" title="Qida's Blog"><meta name="generator" content="Hexo 4.2.1"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><a href="/" class="title-link">Qida's Blog</a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">Java 集合框架系列（二）集合特性总结</h1><div class="post-info">2018-04-14<a href="/tags/Java/" title="Java" class="post-demo">Java</a></div><div class="post-content"><p>集合接口中的许多修改方法都被标记为<em>可选（optional）</em>。实现类允许按需实现，未实现的方法需抛出运行时异常 <code>UnsupportedOperationException</code>。每个实现类的文档必须指明支持哪些可选操作。集合框架引入下列术语来帮助阐述本规范：</p>
<h1 id="定长-变长"><a href="#定长-变长" class="headerlink" title="定长/变长"></a>定长/变长</h1><p>长度保证不变（即使元素可以更改）的列表称为 <strong><em>fixed-size</em></strong> 定长列表。反之则称为 <strong><em>variable-size</em></strong> 变长列表。</p>
<p>开发中接触最多的定长集合是通过 <code>Arrays.asList()</code> 创建的，该方法是一个适配器接口，将数组适配为定长列表，返回的对象是一个 <code>Arrays</code> 内部类，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a fixed-size list backed by the specified array.  (Changes to</span></span><br><span class="line"><span class="comment"> * the returned list "write through" to the array.)  This method acts</span></span><br><span class="line"><span class="comment"> * as bridge between array-based and collection-based APIs, in</span></span><br><span class="line"><span class="comment"> * combination with &#123;<span class="doctag">@link</span> Collection#toArray&#125;.  The returned list is</span></span><br><span class="line"><span class="comment"> * serializable and implements &#123;<span class="doctag">@link</span> RandomAccess&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This method also provides a convenient way to create a fixed-size</span></span><br><span class="line"><span class="comment"> * list initialized to contain several elements:</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *     List&lt;String&gt; stooges = Arrays.asList("Larry", "Moe", "Curly");</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; the class of the objects in the array</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> a the array by which the list will be backed</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a list view of the specified array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SafeVarargs</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"varargs"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">asList</span><span class="params">(T... a)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;(a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractList</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">RandomAccess</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2764017481108945198L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> E[] a;</span><br><span class="line"></span><br><span class="line">    ArrayList(E[] array) &#123;</span><br><span class="line">        a = Objects.requireNonNull(array);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析发现，涉及元素增删的操作（如 <code>add()、remove()、clear()</code>）该内部类并没有实现，而是使用了父类 <code>AbstractList</code> 的方法，默认抛出 <code>UnsupportedOperationException</code> 异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractCollection</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考手册：</p>
<p><img src="/img/java/collection/arrays_aslist.png" alt="arrays_aslist"></p>
<h1 id="可改-不可改"><a href="#可改-不可改" class="headerlink" title="可改/不可改"></a>可改/不可改</h1><p>不支持修改操作（例如 <code>add</code>、<code>remove</code> 和 <code>clear</code>）的集合称为 <strong><em>unmodifiable</em></strong> 不可修改集合。反之则称为 <strong><em>modifiable</em></strong> 可修改集合。<code>Collections</code> 工具类提供了一组静态工厂方法，用于包装并返回指定集合的不可修改视图（<em>unmodifiable view</em>），如果尝试修改，则会抛出<code>UnsupportedOperationException</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Collections.unmodifiableCollection</span><br><span class="line">Collections.unmodifiableSet</span><br><span class="line">Collections.unmodifiableSortedSet</span><br><span class="line">Collections.unmodifiableNavigableSet</span><br><span class="line">Collections.unmodifiableList</span><br><span class="line">Collections.unmodifiableMap</span><br><span class="line">Collections.unmodifiableSortedMap</span><br><span class="line">Collections.unmodifiableNavigableMap</span><br></pre></td></tr></table></figure>

<p>从源码分析，该包装类覆盖了所有修改方法并抛出异常 <code>UnsupportedOperationException</code>，实现非常简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UnmodifiableCollection</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Collection</span>&lt;<span class="title">E</span>&gt;, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1820017752578914078L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Collection&lt;? extends E&gt; c;</span><br><span class="line"></span><br><span class="line">    UnmodifiableCollection(Collection&lt;? extends E&gt; c) &#123;</span><br><span class="line">        <span class="keyword">if</span> (c==<span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">this</span>.c = c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends E&gt; coll)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeAll</span><span class="params">(Collection&lt;?&gt; coll)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">retainAll</span><span class="params">(Collection&lt;?&gt; coll)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="可变-不可变"><a href="#可变-不可变" class="headerlink" title="可变/不可变"></a>可变/不可变</h1><p>在 <em>unmodifiable</em> 的基础上，加之保证 <code>Collection</code> 实现类的底层数据为 <code>final</code> 的集合称为 <strong><em>immutable</em></strong> 不可变集合。反之则称为 <strong><em>mutable</em></strong> 可变集合。</p>
<p>Java 9 为 <code>List</code>、<code>Set</code> 和 <code>Map</code> 接口提供了新的静态工厂方法，可以创建这些集合的不可变实例，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = List.of(<span class="string">"apple"</span>, <span class="string">"orange"</span>, <span class="string">"banana"</span>);</span><br><span class="line">Set&lt;String&gt; set = Set.of(<span class="string">"aggie"</span>, <span class="string">"alley"</span>, <span class="string">"steely"</span>);</span><br><span class="line">Map&lt;String, String&gt; map = Map.of(<span class="string">"A"</span>, <span class="string">"Apple"</span>, <span class="string">"B"</span>, <span class="string">"Boy"</span>, <span class="string">"C"</span>, <span class="string">"Cat"</span>);</span><br></pre></td></tr></table></figure>

<p>而 Java 9 之前，要实现不可变集合只能通过第三方库，例如用 Guava 实现相同效果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = ImmutableList.of(<span class="string">"apple"</span>, <span class="string">"orange"</span>, <span class="string">"banana"</span>);</span><br><span class="line">Set&lt;String&gt; set = ImmutableSet.of(<span class="string">"aggie"</span>, <span class="string">"alley"</span>, <span class="string">"steely"</span>);</span><br><span class="line">Map&lt;String, String&gt; map = ImmutableMap.of(<span class="string">"A"</span>, <span class="string">"Apple"</span>, <span class="string">"B"</span>, <span class="string">"Boy"</span>, <span class="string">"C"</span>, <span class="string">"Cat"</span>);</span><br></pre></td></tr></table></figure>

<p>Guava 提供的不可变集合 API 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ImmutableAsList</span><br><span class="line">ImmutableBiMap</span><br><span class="line">ImmutableClassToInstanceMap</span><br><span class="line">ImmutableCollection</span><br><span class="line">ImmutableEntry</span><br><span class="line">ImmutableEnumMap</span><br><span class="line">ImmutableEnumSet</span><br><span class="line">ImmutableList</span><br><span class="line">ImmutableListMultimap</span><br><span class="line">ImmutableMap</span><br><span class="line">ImmutableMapEntry</span><br><span class="line">ImmutableMapEntrySet</span><br><span class="line">ImmutableMapKeySet</span><br><span class="line">ImmutableMapValues</span><br><span class="line">ImmutableMultimap</span><br><span class="line">ImmutableMultiset</span><br><span class="line">ImmutableRangeMap</span><br><span class="line">ImmutableRangeSet</span><br><span class="line">ImmutableSet</span><br><span class="line">ImmutableSetMultimap</span><br><span class="line">ImmutableSortedAsList</span><br><span class="line">ImmutableSortedMap</span><br><span class="line">ImmutableSortedMapFauxverideShim</span><br><span class="line">ImmutableSortedMultiset</span><br><span class="line">ImmutableSortedMultisetFauxverideShim</span><br><span class="line">ImmutableSortedSet</span><br><span class="line">ImmutableSortedSetFauxverideShim</span><br><span class="line">ImmutableTable</span><br></pre></td></tr></table></figure>

<p><img src="/img/java/collection/immutable_collections.PNG" alt="immutable_collections"></p>
<p>使用如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = ImmutableList.of(<span class="string">"apple"</span>, <span class="string">"orange"</span>, <span class="string">"banana"</span>);</span><br><span class="line">Set&lt;String&gt; set = ImmutableSet.of(<span class="string">"aggie"</span>, <span class="string">"alley"</span>, <span class="string">"steely"</span>);</span><br><span class="line">Map&lt;String, String&gt; map = ImmutableMap.of(<span class="string">"A"</span>, <span class="string">"Apple"</span>, <span class="string">"B"</span>, <span class="string">"Boy"</span>, <span class="string">"C"</span>, <span class="string">"Cat"</span>);</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">"list=&#123;&#125;, set=&#123;&#125;, map=&#123;&#125;"</span>, fruits, marbles, map);  <span class="comment">// list=[apple, orange, banana], set=[aggie, alley, steely], map=&#123;A=Apple, B=Boy, C=Cat&#125;</span></span><br></pre></td></tr></table></figure>

<p>除此之外，Apache Commons Lang 也提供了两个好用的类 <code>Pair</code> 和 <code>Triple</code>，可用于存放指定个数的临时数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Triple.of(<span class="string">"left"</span>, <span class="string">"middle"</span>, <span class="string">"right"</span>)</span><br><span class="line">Pair.of(<span class="string">"left"</span>, <span class="string">"right"</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/java/collection/methods_of_Pair_and_Triple.png" alt="methods_of_Pair_and_Triple"></p>
<h1 id="随机-顺序访问"><a href="#随机-顺序访问" class="headerlink" title="随机/顺序访问"></a>随机/顺序访问</h1><p>支持根据下标索引快速（时间复杂度 <code>0(1)</code>）访问元素的列表称为 <strong><em>random access</em></strong> 随机访问列表。反之则称为 <strong><em>sequential access</em></strong> 顺序访问列表。</p>
<p>标记接口 <code>java.util.RandomAccess</code> 用于标记列表类支持随机访问，其实现类如下：</p>
<p><img src="/img/java/collection/RandomAccess.png" alt="RandomAccess"></p>
<p>该标记接口使得 <code>Collections</code> 工具类中的通用算法实现能够据此更改其行为以提升性能：</p>
<ul>
<li><code>binarySearch</code></li>
<li><code>reverse</code></li>
<li><code>shuffle</code></li>
<li><code>fill</code></li>
<li><code>copy</code></li>
<li><code>rotate</code></li>
<li><code>replaceAll</code></li>
<li><code>indexOfSubList</code></li>
<li><code>lastIndexOfSubList</code></li>
<li><code>checkedList</code></li>
</ul>
<p>以 <code>binarySearch</code> 为例，源码判断如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">int</span> <span class="title">binarySearch</span><span class="params">(List&lt;? extends Comparable&lt;? <span class="keyword">super</span> T&gt;&gt; list, T key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (list <span class="keyword">instanceof</span> RandomAccess || list.size()&lt;BINARYSEARCH_THRESHOLD)</span><br><span class="line">        <span class="keyword">return</span> Collections.indexedBinarySearch(list, key);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> Collections.iteratorBinarySearch(list, key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="元素限制"><a href="#元素限制" class="headerlink" title="元素限制"></a>元素限制</h1><p>某些集合实现限制了可以存储哪些元素。可能的限制包括：</p>
<ul>
<li>元素不能为 <code>null</code>。</li>
<li>元素必须属于特定类型。</li>
<li>元素必须匹配某些断言。</li>
</ul>
<p>尝试添加违反集合实现限制的元素将导致运行时异常，如 <code>ClassCastException</code>、<code>IllegalArgumentException</code> 或 <code>NullPointerException</code>。</p>
<h2 id="能否为-null"><a href="#能否为-null" class="headerlink" title="能否为 null"></a>能否为 null</h2><p>参考手册：</p>
<p><img src="/img/java/collection/map_element_of_null.png" alt="map_element_of_null"></p>
<h2 id="类型限制"><a href="#类型限制" class="headerlink" title="类型限制"></a>类型限制</h2><p>泛型机制虽然为集合提供了编译期类型检查，但仍然可以在运行期绕过此机制（通过反射也能绕过编译期类型检查）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; intList = Lists.newArrayList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">    add(intList);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 循环到第四个元素时，报错：java.lang.ClassCastException: java.lang.String cannot be cast to java.lang.Integer</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> item : intList) &#123;</span><br><span class="line">        log.info(<span class="string">"result is &#123;&#125;"</span>, item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(List list)</span> </span>&#123;</span><br><span class="line">    list.add(<span class="string">"4"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>集合框架提供了一组包装器实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Collections.checkedCollection</span><br><span class="line">Collections.checkedQueue</span><br><span class="line">Collections.checkedSet</span><br><span class="line">Collections.checkedSortedSet</span><br><span class="line">Collections.checkedNavigableSet</span><br><span class="line">Collections.checkedList</span><br><span class="line">Collections.checkedMap</span><br><span class="line">Collections.checkedSortedMap</span><br><span class="line">Collections.checkedNavigableMap</span><br></pre></td></tr></table></figure>

<p>这些包装器实现用于返回指定集合的动态类型安全视图（<em>dynamically type-safe view</em>），核心源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckedCollection</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Collection</span>&lt;<span class="title">E</span>&gt;, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1578914078182001775L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Collection&lt;E&gt; c;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;E&gt; type;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function">E <span class="title">typeCheck</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o != <span class="keyword">null</span> &amp;&amp; !type.isInstance(o))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassCastException(badElementMsg(o));</span><br><span class="line">        <span class="keyword">return</span> (E) o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">badElementMsg</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Attempt to insert "</span> + o.getClass() +</span><br><span class="line">            <span class="string">" element into collection with element type "</span> + type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CheckedCollection(Collection&lt;E&gt; c, Class&lt;E&gt; type) &#123;</span><br><span class="line">        <span class="keyword">this</span>.c = Objects.requireNonNull(c, <span class="string">"c"</span>);</span><br><span class="line">        <span class="keyword">this</span>.type = Objects.requireNonNull(type, <span class="string">"type"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> c.add(typeCheck(e));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以 <code>add</code> 方法为例，每次添加元素时，都会调用 <code>typeCheck</code> 私有方法进行类型检查，如果尝试添加错误类型的元素，则会抛出 <code>ClassCastException</code>，通过 fail fast 防止后续出错：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; intList = Collections.checkedList(Lists.newArrayList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), Integer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    add(intList);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> item : intList) &#123;</span><br><span class="line">        log.info(<span class="string">"result is &#123;&#125;"</span>, item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(List list)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// java.lang.ClassCastException: Attempt to insert class java.lang.String element into collection with element type class java.lang.Integer</span></span><br><span class="line">    list.add(<span class="string">"4"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="数组转-List-方法"><a href="#数组转-List-方法" class="headerlink" title="数组转 List 方法"></a>数组转 List 方法</h1><p>方法一：转两次</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>))  <span class="comment">// from varargs</span></span><br></pre></td></tr></table></figure>

<p>方法二：Java 8 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 包装类型</span></span><br><span class="line">Integer [] myArray = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</span><br><span class="line">List&lt;Integer&gt; myList = Arrays.stream(myArray).collect(Collectors.toList());</span><br><span class="line"><span class="comment">// 基本类型也可以实现转换（依赖 boxed 的装箱操作）</span></span><br><span class="line"><span class="keyword">int</span> [] myArray2 = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</span><br><span class="line">List&lt;Integer&gt; myList2 = Arrays.stream(myArray2).boxed().collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p>方法三：Guava</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不可变集合</span></span><br><span class="line">List&lt;String&gt; il = ImmutableList.of(<span class="string">"string"</span>, <span class="string">"elements"</span>);  <span class="comment">// from varargs</span></span><br><span class="line">List&lt;String&gt; i2 = ImmutableList.copyOf(<span class="keyword">new</span> String[]&#123;<span class="string">"string"</span>, <span class="string">"elements"</span>&#125;);  <span class="comment">// from array</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 可变集合</span></span><br><span class="line">List&lt;String&gt; l0 = Lists.newLinkedList(Arrays.asList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>));  <span class="comment">// from collection</span></span><br><span class="line">List&lt;String&gt; l1 = Lists.newArrayList(Arrays.asList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>));  <span class="comment">// from collection</span></span><br><span class="line">List&lt;String&gt; l2 = Lists.newArrayList(<span class="keyword">new</span> String[]&#123;<span class="string">"string"</span>, <span class="string">"elements"</span>&#125;);  <span class="comment">// from array</span></span><br><span class="line">List&lt;String&gt; l3 = Lists.newArrayList(<span class="string">"or"</span>, <span class="string">"string"</span>, <span class="string">"elements"</span>); <span class="comment">// from varargs</span></span><br></pre></td></tr></table></figure>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>《<a href="https://mp.weixin.qq.com/s/-jWmAqAbc-vLV9w541NhxQ" target="_blank" rel="noopener">Arrays.asList()原来是这样用的</a>》</p>
<p>《<a href="https://mp.weixin.qq.com/s/7ILvz9UreVco0sq9s-zJNg" target="_blank" rel="noopener">千万不要这样使用Arrays.asList !</a>》</p>
<p>《<a href="https://www.cnblogs.com/peida/p/Guava_ImmutableCollections.html" target="_blank" rel="noopener">Guava学习笔记：Immutable(不可变)集合</a>》</p>
<p>《<a href="https://blog.csdn.net/Seriousplus/article/details/79750581" target="_blank" rel="noopener">Java 中的 Mutable 和 Immutable</a>》（<a href="http://web.mit.edu/6.031/www/sp17/classes/09-immutability/" target="_blank" rel="noopener">en_US</a>）</p>
<p><a href="https://stackoverflow.com/questions/7713274/java-immutable-collections" target="_blank" rel="noopener">https://stackoverflow.com/questions/7713274/java-immutable-collections</a></p>
<ul>
<li>Unmodifiable collections are usually read-only views (wrappers) of other collections. You can’t add, remove or clear them, but <strong>the underlying collection can change</strong>.</li>
<li>Immutable collections can’t be changed at all - they don’t wrap another collection - they have their own <code>final</code> elements.</li>
</ul>
</div></article></div><div class="right-container"><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/DNS/" style="font-size: 12.5px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/GNU-Linux/" style="font-size: 16.67px;">GNU/Linux</a> <a href="/tags/Git/" style="font-size: 17.5px;">Git</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/MySQL/" style="font-size: 19.17px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 11.67px;">Nginx</a> <a href="/tags/Redis/" style="font-size: 10.83px;">Redis</a> <a href="/tags/Spring/" style="font-size: 15.83px;">Spring</a> <a href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">函数式编程</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 18.33px;">前端</a> <a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">响应式编程</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 12.5px;">安全</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">并发编程</a> <a href="/tags/%E5%BB%BA%E7%AB%99/" style="font-size: 13.33px;">建站</a> <a href="/tags/%E7%AE%A1%E7%90%86/" style="font-size: 12.5px;">管理</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 14.17px;">读书笔记</a> <a href="/tags/%E9%87%91%E8%9E%8D/" style="font-size: 12.5px;">金融</a></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2018/04/21/java-collections-framework-concurrent-impl/" class="prev">PREV</a><a href="/2018/04/10/java-collections-framework/" class="next">NEXT</a></div><div class="copyright"><p>© 2014 - 2021 <a href="https://github.com/qidawu" target="_blank">Qida's Blog</a></p><p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/scripts/jquery-1.8.2.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script></body></html>